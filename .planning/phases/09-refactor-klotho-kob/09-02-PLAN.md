---
phase: 09-refactor-klotho-kob
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/commands/start.rs
  - README.md
autonomous: true

must_haves:
  truths:
    - "Linked directories are mounted at their canonical host path (not /home/agent/.klotho)"
    - "KLOTHO_LINKED_DIRS environment variable is parsed as colon-separated paths"
    - "CLI --linked-dir flags are merged with KLOTHO_LINKED_DIRS values"
    - "Symlinks in workspace resolve correctly inside container"
    - "No legacy environment variables remain (KLOTHO_KOB, AGENT_SESSION_KOB, AGENT_SESSION_EXTRA_MOUNTS)"
    - "README documents KLOTHO_LINKED_DIRS with examples"
  artifacts:
    - path: "src/commands/start.rs"
      provides: "Correct mount logic for linked directories"
      contains: "KLOTHO_LINKED_DIRS"
    - path: "README.md"
      provides: "User documentation for linked directories feature"
      contains: "KLOTHO_LINKED_DIRS"
  key_links:
    - from: "src/commands/start.rs"
      to: "mount_args vector"
      via: "canonicalize() and same-path mounting"
      pattern: 'format!.*canonical.*canonical'
---

<objective>
Fix the linked directories mount path bug, rename to KLOTHO_LINKED_DIRS, remove all legacy environment variable support, and document the feature.

Purpose: Complete the KLOTHO_KOB refactoring - symlinks will work correctly inside containers because directories are mounted at the same path as on the host.
Output: Working linked directories feature with proper mount paths, clean codebase without legacy variables, and documented usage.
</objective>

<execution_context>
@/home/owen/.claude/get-shit-done/workflows/execute-plan.md
@/home/owen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-refactor-klotho-kob/09-CONTEXT.md
@.planning/phases/09-refactor-klotho-kob/09-RESEARCH.md
@.planning/phases/09-refactor-klotho-kob/09-01-SUMMARY.md

@src/commands/start.rs
@src/cli.rs
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor mount logic for linked directories</name>
  <files>src/commands/start.rs</files>
  <action>
**Update the `run()` function signature** to accept the new `linked_dirs` parameter:
```rust
pub fn run(
    agent: Option<String>,
    name: String,
    linked_dirs: Vec<String>,  // NEW
    paths: Vec<String>,
    runtime_override: Option<&str>,
) -> Result<()> {
```

**Replace lines 92-124** (KLOTHO_KOB and legacy variable handling) with the new implementation:

```rust
// KLOTHO_LINKED_DIRS: directories mounted at same path for symlink resolution
let mut all_linked_dirs = Vec::new();

// Parse environment variable (colon-separated)
if let Ok(env_dirs) = env::var("KLOTHO_LINKED_DIRS") {
    for dir in env_dirs.split(':') {
        let dir = dir.trim();
        if !dir.is_empty() {
            all_linked_dirs.push(dir.to_string());
        }
    }
}

// Add CLI flags (merge with env var)
all_linked_dirs.extend(linked_dirs);

// Deduplicate
all_linked_dirs.sort();
all_linked_dirs.dedup();

// Build mount arguments for linked directories
for dir in &all_linked_dirs {
    let path = PathBuf::from(dir);
    if !path.exists() {
        eprintln!("warning: linked directory does not exist, skipping: {}", dir);
        continue;
    }

    let canonical = path
        .canonicalize()
        .context(format!("failed to resolve linked directory: {}", dir))?;

    // Mount at same path as host - critical for symlink resolution
    mount_args.push("-v".to_string());
    mount_args.push(format!("{}:{}:Z", canonical.display(), canonical.display()));
}

// KLOTHO_MOUNTS: additional mount specifications (keep this, no legacy fallback)
if let Ok(mounts) = env::var("KLOTHO_MOUNTS") {
    for mount in mounts.split(',') {
        let mount = mount.trim();
        if !mount.is_empty() {
            mount_args.push("-v".to_string());
            mount_args.push(mount.to_string());
        }
    }
}
```

**Remove entirely:**
- Lines 92-102: The KLOTHO_KOB and AGENT_SESSION_KOB handling
- Lines 107-114: The AGENT_SESSION_EXTRA_MOUNTS fallback from KLOTHO_MOUNTS

**Keep unchanged:**
- Optional mounts section (lines 126-145)
- Claude.json mount (lines 147-152)

**Update main.rs** to pass `linked_dirs` to the start command. Find where `start::run()` is called and add the parameter.
  </action>
  <verify>Run `cargo build` to confirm compilation. Test manually: `KLOTHO_LINKED_DIRS=/tmp cargo run -- start --linked-dir /var/tmp .` should attempt to start (may fail if no image built, but mount args should be constructed correctly). Check that no references to KLOTHO_KOB or AGENT_SESSION_* remain: `grep -r "KLOTHO_KOB\|AGENT_SESSION" src/`</verify>
  <done>Start command mounts linked directories at canonical host path. KLOTHO_LINKED_DIRS parsed correctly. All legacy environment variable support removed.</done>
</task>

<task type="auto">
  <name>Task 2: Update README documentation</name>
  <files>README.md</files>
  <action>
**Update the Environment Variables table** in the Configuration section (around line 254):

Replace:
```markdown
| Variable | Purpose |
|----------|---------|
| `KLOTHO_MOUNTS` | Additional mount specifications |
| `KLOTHO_KOB` | Keep-container-open behavior control |
```

With:
```markdown
| Variable | Purpose |
|----------|---------|
| `KLOTHO_MOUNTS` | Additional mount specifications (comma-separated, e.g., `/host/path:/container/path:Z`) |
| `KLOTHO_LINKED_DIRS` | Directories mounted at same path for symlink resolution (colon-separated) |
```

**Update the start command section** (around lines 88-113):

In the Options section, add:
```markdown
- `--linked-dir DIR` â€” Directory to mount at same path (repeatable, for symlinks)
```

Add a new section after the Examples:
```markdown
**Linked Directories:**

When your workspace contains symlinks to external directories, those directories must be mounted at the same path inside the container for the symlinks to resolve:

```bash
# Using environment variable (colon-separated)
export KLOTHO_LINKED_DIRS="/home/user/shared-tools:/home/user/team-configs"
klotho start ~/project

# Using CLI flag (repeatable)
klotho start --linked-dir /home/user/shared-tools --linked-dir /home/user/team-configs ~/project
```

The symlinks themselves can be excluded from git via `.git/info/exclude`.
```

**Remove the note** about `KLOTHO_KOB` from line 111.
  </action>
  <verify>Read the README and confirm: 1) KLOTHO_LINKED_DIRS is documented with clear explanation, 2) --linked-dir flag is in the start command options, 3) No references to KLOTHO_KOB remain.</verify>
  <done>README documents KLOTHO_LINKED_DIRS environment variable and --linked-dir CLI flag with examples and use case explanation.</done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds
2. `grep -r "KLOTHO_KOB\|AGENT_SESSION" src/` returns no matches
3. `grep "KLOTHO_LINKED_DIRS" src/commands/start.rs` finds the new implementation
4. `grep "KLOTHO_LINKED_DIRS" README.md` finds documentation
5. `grep "KLOTHO_KOB" README.md` returns no matches
6. Help text `cargo run -- start --help` shows `--linked-dir` option
</verification>

<success_criteria>
- [ ] Linked directories mounted at canonical host path (format `path:path:Z`)
- [ ] KLOTHO_LINKED_DIRS environment variable parsed as colon-separated
- [ ] CLI --linked-dir flags merged with env var values
- [ ] No KLOTHO_KOB references in codebase
- [ ] No AGENT_SESSION_* references in codebase
- [ ] README documents KLOTHO_LINKED_DIRS with examples
- [ ] README documents --linked-dir CLI flag
- [ ] cargo build succeeds with no warnings
</success_criteria>

<output>
After completion, create `.planning/phases/09-refactor-klotho-kob/09-02-SUMMARY.md`
</output>

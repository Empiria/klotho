---
phase: 06-rename-to-klotho
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/build.sh
  - klotho
autonomous: true

must_haves:
  truths:
    - "Build script creates images tagged klotho-<agent>:latest"
    - "klotho ls shows both old (claude-default) and new (klotho-claude-default) containers"
    - "Existing sessions remain accessible after upgrade"
  artifacts:
    - path: "scripts/build.sh"
      provides: "Build script with klotho image naming"
      contains: "klotho-${AGENT_NAME}:latest"
    - path: "klotho"
      provides: "CLI with dual container name detection"
      contains: "klotho-.*-"
  key_links:
    - from: "scripts/build.sh"
      to: "podman build"
      via: "-t klotho-${AGENT_NAME}:latest"
      pattern: "klotho-\\$\\{AGENT_NAME\\}"
    - from: "klotho"
      to: "podman ps"
      via: "find_container with dual pattern"
      pattern: "klotho-.*-|claude-|opencode-"
---

<objective>
Update the build system to use new image naming and add backward compatibility for container detection.

Purpose: Enable new container images with klotho-* naming while ensuring existing sessions remain accessible.
Output: Build script producing klotho-<agent>:latest images. CLI detecting both old and new container name patterns.
</objective>

<execution_context>
@/home/owen/.claude/get-shit-done/workflows/execute-plan.md
@/home/owen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-rename-to-klotho/06-RESEARCH.md
@scripts/build.sh
@klotho
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update build system for new image naming</name>
  <files>scripts/build.sh</files>
  <action>
1. Update image tag pattern in scripts/build.sh:
   - "agent-session-${AGENT_NAME}:latest" -> "klotho-${AGENT_NAME}:latest"

2. Update XDG config path for consistency:
   - Check "$config_home/klotho/agents/$agent/config.conf" first
   - Fall back to "$config_home/agent-session/agents/$agent/config.conf"
   - Add deprecation warning when using old path

3. Update echo statements:
   - "Image tag: agent-session-..." -> "Image tag: klotho-..."
   - "Build complete: agent-session-..." -> "Build complete: klotho-..."
  </action>
  <verify>
```bash
grep -n "klotho-\${AGENT_NAME}" scripts/build.sh  # Should find image tag line
grep -n "agent-session" scripts/build.sh  # Should only find backward compat fallback
```
  </verify>
  <done>Build script uses klotho-${AGENT_NAME}:latest for image tags with XDG path compatibility.</done>
</task>

<task type="auto">
  <name>Task 2: Update container name detection for backward compatibility</name>
  <files>klotho</files>
  <action>
1. Update agent_is_built() function to check new image name:
   ```bash
   agent_is_built() {
       local agent="$1"
       podman image exists "klotho-${agent}:latest" 2>/dev/null
   }
   ```

2. Update find_container() to detect both old and new container name patterns:
   ```bash
   find_container() {
       local session_name="$1"
       local container

       # Try new pattern first: klotho-<agent>-<session>
       container=$(podman ps -a --format "{{.Names}}" | grep -E "^klotho-[^-]+-${session_name}$" | head -1)

       # Fall back to old pattern: <agent>-<session>
       if [[ -z "$container" ]]; then
           container=$(podman ps -a --format "{{.Names}}" | grep -E "^(claude|opencode|aider|codex)-${session_name}$" | head -1)
       fi

       echo "$container"
   }
   ```

3. Update cmd_start() to use new container naming:
   - Container name: "klotho-${AGENT_TYPE}-${SESSION_NAME}"

4. Update cmd_ls() to detect both patterns when listing sessions:
   - Show containers matching "klotho-*-*" pattern
   - Also show containers matching old "<agent>-*" pattern
   - Extract session name correctly from both formats

5. Update IMAGE_NAME variable in cmd_start():
   - "agent-session-${AGENT_TYPE}:latest" -> "klotho-${AGENT_TYPE}:latest"
  </action>
  <verify>
```bash
# Check function updates
grep -A5 "agent_is_built()" klotho | grep "klotho-"
grep -A10 "find_container()" klotho | grep -E "klotho-|claude-|opencode-"

# If containers exist, test listing
./klotho ls 2>/dev/null || echo "No containers to list (expected if none running)"
```
  </verify>
  <done>Container detection supports both klotho-<agent>-<session> (new) and <agent>-<session> (old) patterns.</done>
</task>

</tasks>

<verification>
- [ ] `grep "klotho-\${AGENT_NAME}" scripts/build.sh` finds image tag
- [ ] `grep "klotho-\${agent}" klotho` finds image existence check
- [ ] find_container() has both new and old pattern matching
- [ ] cmd_ls() can detect containers with either naming pattern
- [ ] New sessions would be named klotho-<agent>-<session>
</verification>

<success_criteria>
- Build script creates images tagged klotho-<agent>:latest
- agent_is_built() checks for klotho-<agent>:latest images
- find_container() detects both old (<agent>-<session>) and new (klotho-<agent>-<session>) patterns
- New sessions created with klotho-<agent>-<session> naming
- Existing sessions remain accessible
</success_criteria>

<output>
After completion, create `.planning/phases/06-rename-to-klotho/06-02-SUMMARY.md`
</output>

---
phase: 04-session-management
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - agent-session
autonomous: true

must_haves:
  truths:
    - "Running `agent-session ls` shows all sessions with name, agent type, and colored status"
    - "Running `agent-session ls` with no sessions shows 'No sessions found'"
    - "Running `agent-session rm NAME` prompts for confirmation before removing"
    - "Running `agent-session rm -f NAME` removes without prompting"
    - "Cannot remove a running session - error tells user to stop first"
    - "Session not found shows error with hint to use ls"
  artifacts:
    - path: "agent-session"
      provides: "Complete CLI with ls and rm commands"
      contains: "case.*ls\\)|case.*rm\\)"
  key_links:
    - from: "cmd_ls()"
      to: "podman ps"
      via: "format and filter"
      pattern: "podman ps -a --format"
    - from: "cmd_rm()"
      to: "podman rm"
      via: "confirmation gate"
      pattern: "read -p.*Remove session"
---

<objective>
Implement ls and rm commands to complete session management CLI.

Purpose: Users can see all their sessions at a glance and clean up stopped sessions without using raw podman commands.

Output: Complete agent-session CLI with list and remove functionality.
</objective>

<execution_context>
@/home/owen/.claude/get-shit-done/workflows/execute-plan.md
@/home/owen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-session-management/04-CONTEXT.md
@.planning/phases/04-session-management/04-RESEARCH.md
@.planning/phases/04-session-management/04-01-SUMMARY.md
@agent-session
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ls command</name>
  <files>agent-session</files>
  <action>
Implement cmd_ls() function:

1. Query all agent session containers:
   - Use podman ps -a --format "{{.Names}}|{{.Status}}"
   - Filter to only agent containers using grep -E "^(claude|opencode)-" || true
   - The || true handles case where no containers match

2. Handle empty result:
   - If containers variable is empty, echo "No sessions found" and return 0

3. Print formatted output with header:
   - Header: printf "%-20s %-12s %s\n" "NAME" "AGENT" "STATUS"
   - Use a while loop to read each line

4. Parse container name and status:
   - Container name format: ${AGENT_TYPE}-${SESSION_NAME}
   - Extract agent_type="${name%%-*}" (before first hyphen)
   - Extract session_name="${name#*-}" (after first hyphen)
   - Status from podman is like "Up 2 hours" or "Exited (0) 3 hours ago"

5. Determine running/stopped and apply colors:
   - If status starts with "Up", it's running -> green
   - Otherwise it's stopped -> red
   - Use the COLOR_GREEN, COLOR_RED, COLOR_RESET constants from Plan 01

6. Print each row:
   - printf "%-20s %-12s ${color}%s${COLOR_RESET}\n" "$session_name" "$agent_type" "$state"

CONTEXT.md decisions:
- Colors: green=running, red=stopped
- Empty session list: "No sessions found" message
- Output format at Claude's discretion (table chosen for clarity)

RESEARCH.md pitfall #4: Colors may break in non-terminal context
- Check if stdout is terminal: [[ -t 1 ]]
- If not terminal, skip color codes (set colors to empty strings)
  </action>
  <verify>
Test ls command:
1. With no sessions: `./agent-session ls` shows "No sessions found"
2. Create session: `./agent-session start -n ls-test ~/projects/agent-session`
3. Detach
4. `./agent-session ls` shows table with ls-test, claude (or selected agent), green "running"
5. `./agent-session stop ls-test`
6. `./agent-session ls` shows ls-test with red "stopped"
7. Verify colors appear correctly in terminal
8. `./agent-session ls | cat` shows no broken escape codes (colors disabled for pipes)
  </verify>
  <done>
cmd_ls() shows formatted table of all agent sessions with name, agent type, and colored status. Empty state handled. Colors disabled when output is piped.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement rm command</name>
  <files>agent-session</files>
  <action>
Implement cmd_rm() function:

1. Parse arguments:
   - Check for -f or --force flag
   - Remaining positional arg is session name (optional, defaults to cwd basename)
   - Use while loop to process args:
     - -f|--force -> force=true; shift
     - * -> session_name="$1"; shift

2. Resolve session name and find container:
   - Use resolve_session_name() helper
   - Use find_container() helper
   - Exit 1 if not found (find_container already shows error)

3. Check if container is running:
   - Use: podman ps --format "{{.Names}}" | grep -q "^${container}$"
   - If running, error: "Cannot remove running session. Stop it first." and exit 1
   - This is per CONTEXT.md: "Cannot rm a running container"

4. Prompt for confirmation (unless --force):
   - If not force: read -p "Remove session '$session_name'? [y/N] " -n 1 -r
   - Echo newline after read
   - If reply not y/Y: echo "Cancelled." and exit 0

5. Remove container:
   - Run: podman rm "$container" >/dev/null
   - Output: "Removed: $session_name"

CONTEXT.md decisions:
- rm prompts by default; --force/-f skips prompt
- Cannot rm running container - error tells user to stop first
- No bulk remove - single session at a time
  </action>
  <verify>
Test rm command:
1. Create and stop session:
   - `./agent-session start -n rm-test ~/projects/agent-session`
   - Detach and `./agent-session stop rm-test`
2. Try rm with prompt:
   - `./agent-session rm rm-test`
   - Press 'n' -> should cancel
   - Verify container still exists: `podman ps -a | grep rm-test`
3. Run again, press 'y':
   - `./agent-session rm rm-test`
   - Press 'y' -> "Removed: rm-test"
   - Verify gone: `podman ps -a | grep rm-test` (no output)
4. Test force flag:
   - Create another: `./agent-session start -n rm-force-test ~/projects/agent-session`
   - Detach, stop: `./agent-session stop rm-force-test`
   - `./agent-session rm -f rm-force-test` (no prompt, immediate removal)
5. Test cannot rm running:
   - Create: `./agent-session start -n rm-running-test ~/projects/agent-session`
   - Detach
   - `./agent-session rm rm-running-test`
   - Should error: "Cannot remove running session. Stop it first."
   - Clean up: `./agent-session stop rm-running-test && ./agent-session rm -f rm-running-test`
  </verify>
  <done>
cmd_rm() removes stopped containers with confirmation prompt. Force flag skips prompt. Running containers cannot be removed - clear error message provided.
  </done>
</task>

</tasks>

<verification>
Complete CLI functionality verified:
- `./agent-session ls` shows sessions with colored status
- `./agent-session ls` handles empty state gracefully
- `./agent-session rm NAME` prompts before removal
- `./agent-session rm -f NAME` removes without prompt
- Cannot rm running session (tells user to stop first)
- All error messages include helpful hints
</verification>

<success_criteria>
1. cmd_ls() displays formatted session table with colors
2. Colors disabled when output piped (terminal detection)
3. cmd_rm() prompts for confirmation by default
4. --force/-f flag skips confirmation
5. Running containers cannot be removed (explicit error)
6. Phase 4 requirements (SES-01 through SES-04) all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-session-management/04-02-SUMMARY.md`
</output>

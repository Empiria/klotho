---
phase: 02-agent-abstraction
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - Containerfile
  - agent-session
  - scripts/build.sh
  - config/agents/claude/config.conf
  - docs/AGENTS.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Wrapper script name is derived from AGENT_NAME, not hardcoded"
    - "Adding a new agent requires only config file and Containerfile stage changes"
    - "Config format contains only fields that are actually used"
  artifacts:
    - path: "Containerfile"
      provides: "Dynamic wrapper script naming using AGENT_NAME ARG"
      contains: "${AGENT_NAME}-session"
    - path: "agent-session"
      provides: "Dynamic wrapper path construction from config"
      pattern: "AGENT_NAME.*-session"
    - path: "config/agents/claude/config.conf"
      provides: "Agent config without unused fields"
    - path: "scripts/build.sh"
      provides: "Passes AGENT_NAME to container build"
      pattern: "--build-arg AGENT_NAME"
    - path: "docs/AGENTS.md"
      provides: "Documentation matching actual config format"
  key_links:
    - from: "agent-session"
      to: "config/agents/*/config.conf"
      via: "AGENT_NAME variable used to build wrapper path"
      pattern: "/home/agent/.local/bin/\\$.*-session"
    - from: "Containerfile"
      to: "ARG AGENT_NAME"
      via: "Build-time ARG used for wrapper script name"
      pattern: "ARG AGENT_NAME"
---

<objective>
Close verification gaps in Phase 2: Agent Abstraction

Purpose: The phase goal is "Agent definitions are config-driven, enabling easy addition of new agents." Verification found hardcoded wrapper script names that would require orchestration changes when adding new agents, violating the config-only goal.

Output: Updated Containerfile and agent-session that use dynamic wrapper names derived from AGENT_NAME, plus removal of unused AGENT_REQUIRED_MOUNTS field to eliminate technical debt.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agent-abstraction/02-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make wrapper script name dynamic</name>
  <files>Containerfile, agent-session, scripts/build.sh</files>
  <action>
Fix the hardcoded wrapper script name that blocks adding new agents:

1. **Containerfile** (line 65 area):
   - Add `ARG AGENT_NAME` to the claude stage (alongside other ARGs)
   - Change the wrapper script creation to use dynamic name:
     ```dockerfile
     > ~/.local/bin/${AGENT_NAME}-session && chmod +x ~/.local/bin/${AGENT_NAME}-session
     ```
   - The existing pattern uses `printf '%s\n' ... > file && chmod +x file` - keep that structure

2. **agent-session** (line 141):
   - Change hardcoded `/home/agent/.local/bin/claude-session` to use AGENT_NAME from config
   - The config is already loaded at line 129, so AGENT_NAME is available
   - Update the line to: `/home/agent/.local/bin/${AGENT_NAME}-session`

3. **scripts/build.sh**:
   - Add `--build-arg AGENT_NAME="$AGENT_NAME"` to the podman build command
   - This passes the agent name from config to the Containerfile ARG

WHY: When a new agent (e.g., "aider") is added, its wrapper will be `aider-session`. Without this fix, agent-session would still try to execute `claude-session`, breaking the config-only goal.
  </action>
  <verify>
1. Grep for hardcoded "claude-session" - should find zero matches outside comments
2. Grep for `${AGENT_NAME}-session` pattern - should find matches in both files
3. Run `./scripts/build.sh claude` - should succeed
4. Run `podman run --rm agent-session-claude:latest ls ~/.local/bin/` - should show `claude-session`
  </verify>
  <done>
- Containerfile creates wrapper with name derived from AGENT_NAME ARG
- agent-session uses AGENT_NAME variable to construct wrapper path
- build.sh passes AGENT_NAME to container build
- No hardcoded "claude-session" references remain (except in comments/docs)
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove unused AGENT_REQUIRED_MOUNTS field</name>
  <files>config/agents/claude/config.conf, docs/AGENTS.md</files>
  <action>
Remove the AGENT_REQUIRED_MOUNTS field that is defined but never used:

1. **config/agents/claude/config.conf**:
   - Remove the AGENT_REQUIRED_MOUNTS line (line 25)
   - Remove the comment explaining it (lines 23-24)

2. **docs/AGENTS.md**:
   - Remove AGENT_REQUIRED_MOUNTS from the Required Fields table
   - Remove AGENT_REQUIRED_MOUNTS from the example config
   - Update "Each agent config must define these fields" count if mentioned

WHY: Dead configuration creates false expectations. The field is documented as required but never consumed by any script. Removing it eliminates technical debt and keeps documentation honest. If mount validation is needed in the future, it can be added with actual implementation.
  </action>
  <verify>
1. Grep for AGENT_REQUIRED_MOUNTS - should find zero matches
2. Read config file - should have no AGENT_REQUIRED_MOUNTS line
3. Read docs/AGENTS.md - should have no AGENT_REQUIRED_MOUNTS reference
  </verify>
  <done>
- AGENT_REQUIRED_MOUNTS removed from claude config
- AGENT_REQUIRED_MOUNTS removed from AGENTS.md documentation
- No references to unused field remain in codebase
  </done>
</task>

</tasks>

<verification>
## Gap Closure Verification

1. **Gap 1 (BLOCKER) closed:**
   ```bash
   # Should find NO hardcoded claude-session outside comments
   grep -r "claude-session" --include="*.sh" --include="Containerfile" . | grep -v "^#" | grep -v "# "

   # Should find dynamic pattern
   grep -E '\$\{?AGENT_NAME\}?.*-session' agent-session Containerfile scripts/build.sh
   ```

2. **Gap 2 (WARNING) closed:**
   ```bash
   # Should find NO references to AGENT_REQUIRED_MOUNTS
   grep -r "AGENT_REQUIRED_MOUNTS" .
   ```

3. **End-to-end test:**
   ```bash
   ./scripts/build.sh claude
   # Should complete without errors
   ```
</verification>

<success_criteria>
- [ ] No hardcoded "claude-session" in executable code (agent-session, Containerfile, build.sh)
- [ ] AGENT_NAME ARG added to Containerfile claude stage
- [ ] Wrapper script created with dynamic name `${AGENT_NAME}-session`
- [ ] agent-session uses `${AGENT_NAME}-session` for wrapper path
- [ ] build.sh passes AGENT_NAME to container build
- [ ] AGENT_REQUIRED_MOUNTS removed from config and docs
- [ ] Container builds successfully with `./scripts/build.sh claude`
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-abstraction/02-04-SUMMARY.md`
</output>

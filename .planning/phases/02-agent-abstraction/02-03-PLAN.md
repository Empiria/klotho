---
phase: 02-agent-abstraction
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - agent-session
  - entrypoint.sh
autonomous: false

must_haves:
  truths:
    - "agent-session script loads agent config to get AGENT_LAUNCH_CMD and AGENT_SHELL"
    - "agent-session uses image built by build.sh (agent-session-claude:latest)"
    - "User can start a new Claude session with same workflow as before"
    - "User can reattach to existing session with same workflow as before"
    - "entrypoint.sh uses agent-agnostic logic (no hardcoded claude references)"
  artifacts:
    - path: "agent-session"
      provides: "Config-aware session orchestration"
      contains: "load_agent_config"
    - path: "entrypoint.sh"
      provides: "Agent-agnostic container initialization"
      min_lines: 30
  key_links:
    - from: "agent-session"
      to: "config/agents/claude/config.conf"
      via: "sources config to get launch command"
      pattern: "source.*config.conf"
    - from: "agent-session"
      to: "agent-session-claude:latest"
      via: "uses built image name"
      pattern: "agent-session-.*:latest"
---

<objective>
Update orchestration to use config-driven architecture and verify end-to-end functionality.

Purpose: Complete the abstraction so adding new agents requires only config + Containerfile stage, not orchestration changes.
Output: Updated agent-session that loads config, agent-agnostic entrypoint, verified working Claude sessions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-agent-abstraction/02-CONTEXT.md
@.planning/phases/02-agent-abstraction/02-01-SUMMARY.md
@.planning/phases/02-agent-abstraction/02-02-SUMMARY.md

# Files to modify
@agent-session
@entrypoint.sh
@config/agents/claude/config.conf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update agent-session to load agent config</name>
  <files>agent-session</files>
  <action>
Update agent-session script to be config-driven:

1. **Add --agent flag** (default: "claude" for backward compatibility)
   ```bash
   AGENT_TYPE="claude"
   # In argument parsing:
   -a|--agent)
       AGENT_TYPE="$2"
       shift 2
       ;;
   ```

2. **Add config loading functions** (reuse from build.sh or inline):
   - validate_config() - reject command substitution
   - load_agent_config() - XDG layering (repo default + user override)

3. **Load config early** (after argument parsing, before container checks):
   ```bash
   load_agent_config "$AGENT_TYPE" || exit 1
   ```

4. **Use config values:**
   - Image name: `"agent-session-${AGENT_TYPE}:latest"` instead of hardcoded `claude-agent`
   - Session shell: Use `$AGENT_SHELL` in attach_zellij for claude-session path
   - Container exec environment: Pass `AGENT_LAUNCH_CMD` to wrapper

5. **Update help text:**
   - Add `--agent` option documentation
   - Update examples to show `--agent` usage
   - Keep defaults working (no flag = claude)

6. **Backward compatibility:**
   - Default AGENT_TYPE="claude" means existing `agent-session -n foo` still works
   - Image name change: `claude-agent` -> `agent-session-claude:latest`
   - NOTE: User needs to rebuild image once with `./scripts/build.sh claude`

Key: The orchestration should not contain Claude-specific logic. All agent-specific values come from config.
  </action>
  <verify>
- `./agent-session --help` shows `--agent` option
- `grep "AGENT_TYPE" agent-session` matches (config-driven)
- `grep "claude-agent" agent-session` returns NO matches (no hardcoded image name)
- Script syntax valid: `bash -n agent-session`
  </verify>
  <done>agent-session loads agent config, uses config values for image name and shell, supports --agent flag with claude as default.</done>
</task>

<task type="auto">
  <name>Task 2: Make entrypoint.sh agent-agnostic</name>
  <files>entrypoint.sh</files>
  <action>
Review entrypoint.sh and make it agent-agnostic:

Current Claude-specific references to update:
1. `~/.claude` directory setup - keep, but document as Claude-specific mount pattern
2. `Claude Code $(claude --version)` output - make conditional or generic
3. GSD plugin installation via npx - keep, but document as Claude-specific

Changes:
1. Make version output conditional:
   ```bash
   # Print agent version if available
   if command -v claude &>/dev/null; then
       echo "Claude Code $(claude --version) ready"
   else
       echo "Agent environment ready"
   fi
   ```

2. Make GSD plugin installation conditional (only for Claude):
   ```bash
   # Install GSD plugin if Claude and not already present
   if command -v claude &>/dev/null && [[ ! -f ~/.claude/get-shit-done/VERSION ]]; then
       echo "Installing get-shit-done..."
       npx -y get-shit-done-cc@latest --claude --global
   fi
   ```

3. Keep `.claude` config setup logic - it's already conditional on `/config/.claude` existing

The entrypoint should work for any agent - Claude-specific behavior triggers only when Claude is detected.
  </action>
  <verify>
- No hardcoded "claude" in mandatory paths (only conditional checks)
- `bash -n entrypoint.sh` validates syntax
- Entrypoint still works for Claude (GSD installs, version prints)
  </verify>
  <done>entrypoint.sh has no hardcoded agent assumptions - Claude-specific behavior is conditional on claude binary presence.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Config-driven agent architecture:
- Agent config in config/agents/claude/config.conf
- Multi-stage Containerfile with base + claude stages
- Build script that validates and builds from config
- Updated agent-session that loads config and uses config values
- Agent-agnostic entrypoint
  </what-built>
  <how-to-verify>
1. **Build the new image:**
   ```bash
   ./scripts/build.sh claude
   ```
   Should complete without errors.

2. **Start a new session:**
   ```bash
   # Remove old container if exists
   podman rm -f agent-test 2>/dev/null || true

   # Start new session
   ./agent-session -n test
   ```
   Should start session, show "Claude Code X.X.X ready", drop into Zellij.

3. **Inside container, verify Claude works:**
   ```bash
   claude --version
   ```
   Should show version.

4. **Detach and reattach:**
   - Press Ctrl+O, d to detach from Zellij
   - Run `./agent-session -n test` again
   - Should reattach to existing session

5. **Cleanup:**
   ```bash
   podman stop agent-test && podman rm agent-test
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if session works end-to-end, or describe issues encountered.</resume-signal>
</task>

</tasks>

<verification>
Phase verification (after checkpoint approval):
- New session starts successfully with `./agent-session -n NAME`
- Reattach works with same command
- Claude Code runs inside container
- No regression from Phase 1 functionality
</verification>

<success_criteria>
- agent-session loads config instead of hardcoding agent values
- entrypoint.sh works for any agent (conditional Claude logic)
- User-verified: New session and reattach work correctly
- Adding a new agent requires only: config file + Containerfile stage + rebuild
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-abstraction/02-03-SUMMARY.md`
</output>

---
phase: 02-agent-abstraction
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - Containerfile
  - scripts/build.sh
autonomous: true

must_haves:
  truths:
    - "Containerfile has a base stage with common tools shared by all agents"
    - "Containerfile has a claude stage that inherits from base and installs Claude-specific tools"
    - "Build script validates config file format before sourcing (rejects command substitution)"
    - "Build script validates required config fields are present"
    - "Build script validates Containerfile stage exists before building"
    - "podman build --target=claude produces working image"
  artifacts:
    - path: "Containerfile"
      provides: "Multi-stage container build"
      contains: "FROM base AS claude"
    - path: "scripts/build.sh"
      provides: "Config-driven build script"
      contains: "validate_config"
  key_links:
    - from: "scripts/build.sh"
      to: "config/agents/claude/config.conf"
      via: "sources config file after validation"
      pattern: "source.*config.conf"
    - from: "scripts/build.sh"
      to: "Containerfile"
      via: "passes ARG values and --target flag"
      pattern: "--target.*--build-arg"
---

<objective>
Refactor Containerfile to multi-stage builds and create config-driven build script.

Purpose: Enable building agent-specific container images from config without modifying build logic.
Output: Multi-stage Containerfile with base + claude stages, and build.sh that validates and builds from config.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-agent-abstraction/02-CONTEXT.md
@.planning/phases/02-agent-abstraction/02-RESEARCH.md
@.planning/phases/02-agent-abstraction/02-01-SUMMARY.md

# Reference patterns from research
# Config file format from Plan 01
@config/agents/claude/config.conf

# Current Containerfile to refactor
@Containerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Containerfile to multi-stage build</name>
  <files>Containerfile</files>
  <action>
Refactor the existing Containerfile into multi-stage build with:

**Base stage (shared by all agents):**
```dockerfile
FROM --platform=linux/amd64 debian:bookworm-slim AS base

# Install common tools (curl, git, ca-certificates, fish, nodejs, npm)
# Install Zellij, Starship
# Create non-root user (agent, UID 1000)
# Copy entrypoint.sh
# Set up fish config with starship
# NO agent-specific tools in base
```

**Claude stage (agent-specific):**
```dockerfile
FROM base AS claude

# Accept build args for config values
ARG AGENT_INSTALL_CMD
ARG AGENT_SHELL
ARG AGENT_LAUNCH_CMD

# Install uv (Python MCP servers)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Install Claude Code using config value
RUN eval "$AGENT_INSTALL_CMD"

# Create claude wrapper script using AGENT_LAUNCH_CMD
RUN printf '%s\n' \
    '#!/usr/bin/env fish' \
    "$AGENT_LAUNCH_CMD" \
    'exec fish' \
    > ~/.local/bin/claude-session && chmod +x ~/.local/bin/claude-session

# Set environment from config
ENV PATH="/home/agent/.local/bin:$PATH"
ENV SHELL="$AGENT_SHELL"
```

Key points:
- ARG values must be quoted in RUN commands
- Use eval for AGENT_INSTALL_CMD (may have spaces/pipes)
- Keep uv install in claude stage (Claude-specific for MCP servers)
- Entrypoint and CMD stay in base (shared pattern)
  </action>
  <verify>
- `grep -E "^FROM .* AS base$" Containerfile` matches
- `grep -E "^FROM base AS claude$" Containerfile` matches
- `grep "ARG AGENT_INSTALL_CMD" Containerfile` matches
- Containerfile syntax valid: `podman build --target=base -t test-base . && podman rmi test-base`
  </verify>
  <done>Containerfile has base stage with common tools and claude stage with agent-specific setup via ARG injection.</done>
</task>

<task type="auto">
  <name>Task 2: Create build script with validation</name>
  <files>scripts/build.sh</files>
  <action>
Create `scripts/` directory and `build.sh` script.

Script structure (follow patterns from 02-RESEARCH.md):

1. **Usage:** `./scripts/build.sh <agent-name>` (e.g., `./scripts/build.sh claude`)

2. **validate_config():** Check config file for forbidden constructs
   - Reject if contains: backticks, $(), semicolons, pipes, ampersands
   - Pattern: `grep -E '\`|\$\(|;|\||&' "$config_file"`
   - Return 1 if matches found

3. **load_agent_config():** XDG-style layering
   - Repo default: `./config/agents/$agent/config.conf`
   - User override: `${XDG_CONFIG_HOME:-$HOME/.config}/agent-session/agents/$agent/config.conf`
   - Load repo first, then user override (user wins)
   - Validate each file before sourcing

4. **validate_required_fields():** Check all required fields are non-empty
   - Required: AGENT_NAME, AGENT_DESCRIPTION, AGENT_INSTALL_CMD, AGENT_LAUNCH_CMD, AGENT_SHELL
   - List missing fields in error message

5. **validate_stage_exists():** Check Containerfile has matching stage
   - Pattern: `grep -qE "^FROM .* AS ${AGENT_NAME}\$" Containerfile`
   - On failure, list available stages

6. **Build command:**
   ```bash
   podman build \
       --target="$AGENT_NAME" \
       --build-arg AGENT_INSTALL_CMD="$AGENT_INSTALL_CMD" \
       --build-arg AGENT_SHELL="$AGENT_SHELL" \
       --build-arg AGENT_LAUNCH_CMD="$AGENT_LAUNCH_CMD" \
       -t "agent-session-${AGENT_NAME}:latest" \
       .
   ```

7. **Error messages:** Clear, actionable. On stage missing, show available stages.

Script must be executable (chmod +x).
Use `set -euo pipefail` for safety.
  </action>
  <verify>
- `ls scripts/build.sh` shows file exists
- `bash -n scripts/build.sh` validates syntax
- `./scripts/build.sh` with no args shows usage
- `./scripts/build.sh claude` attempts build (may fail if base not built yet, but validates config first)
  </verify>
  <done>Build script exists, validates config security and required fields, validates stage exists, builds with --target and --build-arg.</done>
</task>

<task type="auto">
  <name>Task 3: Build and test Claude image</name>
  <files></files>
  <action>
Run the build script to create the claude image:

```bash
./scripts/build.sh claude
```

Verify the image was created:
```bash
podman images | grep agent-session-claude
```

This validates the entire pipeline:
- Config loads correctly
- Validation passes
- Stage exists
- Build completes
- Image tagged correctly
  </action>
  <verify>
- `./scripts/build.sh claude` exits 0
- `podman images --format "{{.Repository}}:{{.Tag}}" | grep "agent-session-claude:latest"` returns match
  </verify>
  <done>Claude image builds successfully from config-driven build script.</done>
</task>

</tasks>

<verification>
Phase verification:
- Containerfile has `FROM ... AS base` and `FROM base AS claude` stages
- `./scripts/build.sh claude` completes without errors
- Image `agent-session-claude:latest` exists in podman images
- Build script rejects invalid configs (test with temp file containing `$(whoami)`)
</verification>

<success_criteria>
- Containerfile refactored to multi-stage build with base and claude stages
- Build script validates config security, required fields, and stage existence
- `./scripts/build.sh claude` produces working image
- Build script follows XDG config layering (repo default, user override)
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-abstraction/02-02-SUMMARY.md`
</output>

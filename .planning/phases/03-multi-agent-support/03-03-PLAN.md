---
phase: 03-multi-agent-support
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - agent-session
  - entrypoint.sh
autonomous: false
user_setup:
  - service: opencode
    why: "API key for OpenCode AI agent"
    env_vars:
      - name: ANTHROPIC_API_KEY (or provider of choice)
        source: "Run /connect in first OpenCode session to configure"
    dashboard_config: []

must_haves:
  truths:
    - "OpenCode config directory mounted when present on host"
    - "OpenCode auth directory mounted for API key persistence"
    - "Entrypoint sets up OpenCode config like Claude config"
    - "OpenCode session starts and shows agent ready message"
    - "Interactive menu appears when starting session without --agent flag"
  artifacts:
    - path: "agent-session"
      provides: "OpenCode-specific mount handling"
      contains: "opencode"
    - path: "entrypoint.sh"
      provides: "OpenCode config merge logic"
      contains: "/config/opencode"
  key_links:
    - from: "agent-session"
      to: "$HOME/.config/opencode"
      via: "conditional mount"
      pattern: "config/opencode:/config/opencode"
    - from: "entrypoint.sh"
      to: "~/.config/opencode"
      via: "symlink creation"
      pattern: "ln -s.*opencode"
---

<objective>
Add OpenCode-specific runtime integration to enable sessions with the OpenCode agent.

Purpose: Complete the multi-agent support by wiring OpenCode config mounting and entrypoint setup.
Output: Working OpenCode sessions with MCP servers configured.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-agent-support/03-CONTEXT.md
@.planning/phases/03-multi-agent-support/03-RESEARCH.md
@.planning/phases/03-multi-agent-support/03-01-SUMMARY.md
@.planning/phases/03-multi-agent-support/03-02-SUMMARY.md
@agent-session
@entrypoint.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OpenCode config mounting to agent-session</name>
  <files>agent-session</files>
  <action>
Add OpenCode-specific mounts to agent-session's OPTIONAL_MOUNTS section.

Find the section (around line 198-201):
```bash
# Build optional mounts - only include if directory exists
OPTIONAL_MOUNTS=""
[[ -d "$HOME/.claude" ]] && OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v $HOME/.claude:/config/.claude:Z"
[[ -d "$HOME/.local/share/claude" ]] && OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v $HOME/.local/share/claude:/home/agent/.local/share/claude:Z"
[[ -d "$HOME/.config/zellij" ]] && OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v $HOME/.config/zellij:/config/zellij:ro"
```

Add OpenCode mounts after Claude mounts:
```bash
# OpenCode config and auth directories
[[ -d "$HOME/.config/opencode" ]] && OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v $HOME/.config/opencode:/config/opencode:Z"
[[ -d "$HOME/.local/share/opencode" ]] && OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v $HOME/.local/share/opencode:/home/agent/.local/share/opencode:Z"
```

Also mount the bundled MCP config from config/agents/opencode/:
```bash
# Mount bundled OpenCode MCP config if no user config exists
if [[ "$AGENT_TYPE" == "opencode" ]] && [[ ! -d "$HOME/.config/opencode" ]] && [[ -f "./config/agents/opencode/opencode.json" ]]; then
    mkdir -p /tmp/opencode-config
    cp ./config/agents/opencode/opencode.json /tmp/opencode-config/
    OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v /tmp/opencode-config:/config/opencode:Z"
fi
```

Key points per research:
- OpenCode uses ~/.config/opencode/ for config (including opencode.json for MCP)
- OpenCode uses ~/.local/share/opencode/ for auth (auth.json with API keys)
- Mount bundled MCP config if user has no custom config
  </action>
  <verify>
    - OpenCode mounts added: `grep -c "config/opencode" agent-session` returns 3+
    - Auth directory mounted: `grep "local/share/opencode" agent-session`
    - Conditional bundled config mount: `grep "opencode.json" agent-session`
  </verify>
  <done>OpenCode config and auth directories mounted when present, bundled MCP config used as fallback</done>
</task>

<task type="auto">
  <name>Task 2: Add OpenCode config merge to entrypoint</name>
  <files>entrypoint.sh</files>
  <action>
Add OpenCode config setup to entrypoint.sh, following the same pattern as Claude config.

After the Claude config section (around line 30), add OpenCode section:

```bash
# Set up ~/.config/opencode from mounted /config/opencode
# Similar pattern to Claude: merge mounted config with any existing container config
if [[ -d /config/opencode ]]; then
    mkdir -p ~/.config/opencode
    for item in /config/opencode/* /config/opencode/.*; do
        [[ "$(basename "$item")" == "." || "$(basename "$item")" == ".." ]] && continue
        [[ ! -e "$item" && ! -L "$item" ]] && continue

        name=$(basename "$item")
        target=~/.config/opencode/"$name"

        # Skip if target already exists (prefer container version)
        [[ -e "$target" || -L "$target" ]] && continue

        if [[ -L "$item" && ! -e "$item" ]]; then
            # Broken symlink - create directory instead
            mkdir -p "$target"
        else
            # Valid file/dir/symlink - symlink to mounted version
            ln -s /config/opencode/"$name" "$target"
        fi
    done
fi
```

Update the agent detection section to handle OpenCode:

Replace:
```bash
# Print agent version if available
if command -v claude &>/dev/null; then
    echo "Claude Code $(claude --version) ready"
else
    echo "Agent environment ready"
fi
```

With:
```bash
# Print agent version if available
if command -v claude &>/dev/null; then
    echo "Claude Code $(claude --version) ready"
elif command -v opencode &>/dev/null; then
    echo "OpenCode ready"
    echo "Run /connect to configure API keys if not already set up"
else
    echo "Agent environment ready"
fi
```

Note: GSD installation for OpenCode is uncertain - skip for now. OpenCode uses /connect command for API key setup per research.
  </action>
  <verify>
    - OpenCode config section exists: `grep -c "/config/opencode" entrypoint.sh` returns 3+
    - OpenCode detection added: `grep "command -v opencode" entrypoint.sh`
    - Symlink logic matches Claude pattern: `grep "ln -s /config/opencode" entrypoint.sh`
  </verify>
  <done>Entrypoint sets up OpenCode config directory and detects OpenCode binary for welcome message</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete multi-agent support: OpenCode agent definition, interactive menu, build detection, and runtime integration</what-built>
  <how-to-verify>
**Test 1: Interactive menu appearance (AGT-03 requirement)**

First, ensure both agents are built:
```bash
./scripts/build.sh claude
./scripts/build.sh opencode
```

Start session WITHOUT --agent flag (menu should appear):
```bash
./agent-session -n menu-test ~/projects/personal/agent-session
```

Expected output:
```
Available agents:
  1. Claude (ready)
  2. Opencode (ready)

Select agent (default: claude):
```

Verify:
- Menu shows numbered list with status
- Both agents show "(ready)" since both are built
- Pressing Enter selects claude (first alphabetically)
- Entering "2" selects opencode

Press Ctrl+C to exit without starting container.

**Test 2: OpenCode agent end-to-end**

Start OpenCode session:
```bash
./agent-session --agent opencode -n test-opencode ~/projects/personal/agent-session
```

Inside container, verify:
- OpenCode launches (may need /connect for first-time API key setup)
- MCP servers configured: check ~/.config/opencode/opencode.json exists
- Welcome message shows "OpenCode ready"

**Test 3: --agent flag bypass**

```bash
# Exit current session if running
podman rm -f agent-test-opencode 2>/dev/null

# Start with --agent flag (should skip menu)
./agent-session --agent opencode -n test-opencode ~/projects/personal/agent-session
```

Verify: No menu shown, goes straight to starting opencode session.

**Test 4: Claude regression test**

```bash
podman rm -f agent-test-claude 2>/dev/null
./agent-session --agent claude -n test-claude ~/projects/personal/agent-session
```

Verify: Claude session works as before.

**Test 5: Build prompt for unbuilt agent**

```bash
# Remove opencode image to test build prompt
podman rmi agent-session-opencode:latest

# Start without --agent flag, select opencode
./agent-session -n build-prompt-test ~/projects/personal/agent-session
# When menu appears, enter "2" for opencode
```

Verify: Prompt appears "Image not built. Build now? [y/N]"
  </how-to-verify>
  <resume-signal>Type "approved" if all 5 tests pass, or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
Phase 3 complete verification:
1. Both agents build: `./scripts/build.sh claude && ./scripts/build.sh opencode`
2. Interactive menu works without --agent flag (Test 1 above)
3. --agent flag bypasses menu (Test 3 above)
4. Build prompt appears for unbuilt agents (Test 5 above)
5. Claude sessions work (regression test - Test 4 above)
6. OpenCode sessions start successfully (Test 2 above)
</verification>

<success_criteria>
- Interactive menu appears when --agent not specified with multiple agents
- OpenCode config mounted from ~/.config/opencode when present
- OpenCode auth mounted from ~/.local/share/opencode when present
- Bundled MCP config used when no user config exists
- Entrypoint merges OpenCode config like Claude config
- OpenCode binary detected and welcome message shown
- OpenCode session starts and agent is usable
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-agent-support/03-03-SUMMARY.md`
</output>

---
phase: 03-multi-agent-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config/agents/opencode/config.conf
  - config/agents/opencode/opencode.json
  - Containerfile
autonomous: true

must_haves:
  truths:
    - "OpenCode agent config exists with all required fields"
    - "OpenCode Containerfile stage installs opencode binary"
    - "OpenCode image builds successfully with build.sh"
  artifacts:
    - path: "config/agents/opencode/config.conf"
      provides: "OpenCode agent definition"
      contains: "AGENT_NAME=\"opencode\""
    - path: "config/agents/opencode/opencode.json"
      provides: "MCP server configuration for OpenCode"
      contains: "context7"
    - path: "Containerfile"
      provides: "OpenCode build stage"
      contains: "FROM base AS opencode"
  key_links:
    - from: "config/agents/opencode/config.conf"
      to: "Containerfile"
      via: "AGENT_NAME matches stage name"
      pattern: "AS opencode"
    - from: "scripts/build.sh"
      to: "config/agents/opencode/config.conf"
      via: "config loading with agent name"
      pattern: "source.*config/agents"
---

<objective>
Create OpenCode agent definition following the config-driven architecture established in Phase 2.

Purpose: Enable OpenCode as a second agent type, proving the abstraction works for multiple agents.
Output: OpenCode config, MCP config, and Containerfile stage ready for building.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-agent-support/03-CONTEXT.md
@.planning/phases/03-multi-agent-support/03-RESEARCH.md
@config/agents/claude/config.conf
@Containerfile
@docs/AGENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OpenCode agent config and MCP config</name>
  <files>
    config/agents/opencode/config.conf
    config/agents/opencode/opencode.json
  </files>
  <action>
Create OpenCode agent config following Claude's pattern:

1. Create directory: `config/agents/opencode/`

2. Create `config/agents/opencode/config.conf`:
```bash
# OpenCode Agent Configuration
AGENT_NAME="opencode"
AGENT_DESCRIPTION="OpenCode AI coding agent"
AGENT_INSTALL_CMD="curl -fsSL https://opencode.ai/install | bash"
AGENT_LAUNCH_CMD="opencode"
AGENT_SHELL="/usr/bin/fish"
AGENT_ENV_VARS="PATH=/home/agent/.local/bin:\$PATH SHELL=/usr/bin/fish"
```

3. Create `config/agents/opencode/opencode.json` (MCP server config to be mounted):
```json
{
  "mcp": {
    "context7": {
      "type": "local",
      "command": ["uvx", "@upstash/context7-mcp"],
      "enabled": true
    },
    "serena": {
      "type": "local",
      "command": ["uvx", "--from", "git+https://github.com/oraios/serena", "serena", "start-mcp-server", "--context", "ide-assistant", "--project", "/workspace"],
      "enabled": true
    }
  }
}
```

Note: GSD installation for OpenCode is uncertain per research. Start without it - can add later if needed.
  </action>
  <verify>
    - File exists: `ls config/agents/opencode/config.conf`
    - File exists: `ls config/agents/opencode/opencode.json`
    - Config has all required fields: `grep -c "AGENT_" config/agents/opencode/config.conf` returns 6
    - JSON is valid: `python3 -m json.tool config/agents/opencode/opencode.json >/dev/null`
  </verify>
  <done>OpenCode config and MCP config files exist with all required fields and valid JSON</done>
</task>

<task type="auto">
  <name>Task 2: Add OpenCode stage to Containerfile</name>
  <files>Containerfile</files>
  <action>
Add OpenCode agent stage to Containerfile following Claude's pattern:

Append after the Claude stage:

```dockerfile
# ===== OPENCODE AGENT STAGE =====
FROM base AS opencode

# Accept build args for config values
ARG AGENT_NAME
ARG AGENT_INSTALL_CMD
ARG AGENT_SHELL
ARG AGENT_LAUNCH_CMD

# Install uv (provides uvx for Python MCP servers)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Install OpenCode using config value
RUN eval "$AGENT_INSTALL_CMD"

# Create agent wrapper script using AGENT_LAUNCH_CMD
RUN printf '%s\n' \
    '#!/usr/bin/env fish' \
    "$AGENT_LAUNCH_CMD" \
    'exec fish' \
    > ~/.local/bin/${AGENT_NAME}-session && chmod +x ~/.local/bin/${AGENT_NAME}-session

# Set environment from config
ENV SHELL="$AGENT_SHELL"
```

Key points:
- Same structure as Claude stage (ARGs, uv install, agent install, wrapper script)
- Uses $AGENT_INSTALL_CMD which will be `curl -fsSL https://opencode.ai/install | bash`
- Wrapper script pattern matches Claude for consistency
  </action>
  <verify>
    - Stage exists: `grep -c "FROM base AS opencode" Containerfile` returns 1
    - ARGs declared: `grep "ARG AGENT_NAME" Containerfile | wc -l` returns 2 (one per agent stage)
    - Build succeeds: `./scripts/build.sh opencode` completes without error
  </verify>
  <done>OpenCode stage added to Containerfile and builds successfully</done>
</task>

</tasks>

<verification>
Phase verification:
1. Config validation: `./scripts/build.sh opencode` runs validation and succeeds
2. Image exists: `podman image exists agent-session-opencode:latest`
3. Stage isolation: Building opencode doesn't rebuild claude stage
</verification>

<success_criteria>
- OpenCode config exists at config/agents/opencode/config.conf with all required fields
- OpenCode MCP config exists at config/agents/opencode/opencode.json
- Containerfile has opencode stage that builds successfully
- `./scripts/build.sh opencode` produces agent-session-opencode:latest image
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-agent-support/03-01-SUMMARY.md`
</output>

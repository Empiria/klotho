---
phase: 03-multi-agent-support
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - agent-session
autonomous: true

must_haves:
  truths:
    - "User sees interactive menu when no --agent flag provided"
    - "Menu shows alphabetically sorted agents with build status"
    - "Empty input selects default (first alphabetically)"
    - "Menu skipped if only one agent configured"
    - "Unbuilt agent prompts to build before starting"
  artifacts:
    - path: "agent-session"
      provides: "Interactive agent selection and build detection"
      contains: "select choice"
  key_links:
    - from: "agent-session"
      to: "config/agents/*"
      via: "directory scan for agent discovery"
      pattern: "find config/agents"
    - from: "agent-session"
      to: "podman image exists"
      via: "build status detection"
      pattern: "podman image exists"
---

<objective>
Add interactive agent selection menu and build status detection to agent-session script.

Purpose: Enable users to select agents interactively when --agent flag not provided.
Output: agent-session script with menu selection, build detection, and auto-build prompts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-agent-support/03-CONTEXT.md
@.planning/phases/03-multi-agent-support/03-RESEARCH.md
@agent-session
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agent discovery and interactive menu</name>
  <files>agent-session</files>
  <action>
Modify agent-session to add interactive agent selection:

1. Add agent discovery function (after show_help, before argument parsing):
```bash
# Discover available agents from config directories
discover_agents() {
    mapfile -t agents < <(
        find ./config/agents -mindepth 1 -maxdepth 1 -type d -printf '%f\n' 2>/dev/null \
        | LC_COLLATE=C sort
    )

    if [ ${#agents[@]} -eq 0 ]; then
        echo "error: no agents found in config/agents/" >&2
        exit 1
    fi
}
```

2. Add build status check function:
```bash
# Check if agent image is built
agent_is_built() {
    local agent="$1"
    podman image exists "agent-session-${agent}:latest" 2>/dev/null
}

# Get agent display name with build status
agent_display() {
    local agent="$1"
    local name="${agent^}"  # Capitalize first letter
    if agent_is_built "$agent"; then
        echo "$name (ready)"
    else
        echo "$name (not built)"
    fi
}
```

3. Add interactive menu function:
```bash
# Show interactive agent selection menu
select_agent_interactive() {
    discover_agents

    # Skip menu if only one agent
    if [ ${#agents[@]} -eq 1 ]; then
        AGENT_TYPE="${agents[0]}"
        return
    fi

    echo "Available agents:"
    local i=1
    for agent in "${agents[@]}"; do
        echo "  $i. $(agent_display "$agent")"
        ((i++))
    done
    echo ""

    PS3="Select agent (default: ${agents[0]}): "
    select choice in "${agents[@]}"; do
        if [[ -z "$REPLY" ]]; then
            # Empty input = default (first in list)
            AGENT_TYPE="${agents[0]}"
            break
        elif [[ -n "$choice" ]]; then
            AGENT_TYPE="$choice"
            break
        else
            echo "Invalid selection. Enter a number 1-${#agents[@]} or press Enter for default."
        fi
    done
}
```

4. Modify the main flow - after argument parsing, before `load_agent_config`:

Replace:
```bash
# Load agent config
load_agent_config "$AGENT_TYPE" || exit 1
```

With:
```bash
# If no agent specified via flag, show interactive menu
if [[ "$AGENT_TYPE" == "claude" ]] && [[ "$AGENT_SPECIFIED" != "true" ]]; then
    select_agent_interactive
fi

# Load agent config
load_agent_config "$AGENT_TYPE" || exit 1
```

5. Track whether --agent was explicitly specified by adding `AGENT_SPECIFIED="false"` near the top defaults, and setting `AGENT_SPECIFIED="true"` inside the `-a|--agent)` case block.

Context decisions honored:
- Numbered list format with status in parentheses
- Name only (capitalized), no descriptions in menu
- Enter without input selects default (first alphabetically)
- Invalid input re-shows menu with hint
  </action>
  <verify>
    - Functions exist: `grep -c "discover_agents\|select_agent_interactive\|agent_is_built" agent-session` returns 3+
    - Menu uses select: `grep -c "select choice" agent-session` returns 1
    - LC_COLLATE used for consistent sorting: `grep "LC_COLLATE=C" agent-session`
  </verify>
  <done>Interactive agent menu added with alphabetical sorting, build status display, and default selection on empty input</done>
</task>

<task type="auto">
  <name>Task 2: Add build prompt for unbuilt agents</name>
  <files>agent-session</files>
  <action>
Add build detection and prompt after agent selection, before container operations:

1. Add build prompt function:
```bash
# Prompt to build agent if image doesn't exist
ensure_agent_built() {
    local agent="$1"
    local image="agent-session-${agent}:latest"

    if ! podman image exists "$image" 2>/dev/null; then
        echo ""
        read -p "Image not built. Build now? [y/N] " answer
        answer="${answer:-N}"
        if [[ "$answer" =~ ^[Yy]$ ]]; then
            echo "Building ${agent}..."
            ./scripts/build.sh "$agent" || {
                echo "error: build failed" >&2
                exit 1
            }
        else
            echo "Cannot start session without built image."
            exit 1
        fi
    fi
}
```

2. Call ensure_agent_built after load_agent_config, before CONTAINER_NAME assignment:
```bash
# Load agent config
load_agent_config "$AGENT_TYPE" || exit 1

# Ensure image is built
ensure_agent_built "$AGENT_TYPE"

CONTAINER_NAME="agent-${SESSION_NAME}"
```

Context decisions honored:
- Prompt format: "Image not built. Build now? [y/N]"
- Default is N (user must actively choose to build)
- Exit cleanly if user declines
  </action>
  <verify>
    - Build prompt function exists: `grep -c "ensure_agent_built" agent-session` returns 2+ (definition + call)
    - Uses podman image exists: `grep "podman image exists" agent-session`
    - Calls build.sh: `grep "scripts/build.sh" agent-session`
  </verify>
  <done>Build detection prompts user when image not built, offers to build, exits cleanly on decline</done>
</task>

</tasks>

<verification>
Test scenarios (manual verification):
1. No --agent flag, multiple agents: `./agent-session -n test ~/project` shows menu
2. --agent flag: `./agent-session --agent claude -n test ~/project` skips menu
3. Single agent: Temporarily remove one config, verify menu skipped
4. Unbuilt agent: Select unbuilt agent, verify build prompt appears
5. Empty input: Press Enter at menu, verify first agent selected
6. Invalid input: Enter "99", verify error message and re-prompt
</verification>

<success_criteria>
- Interactive menu appears when --agent not specified
- Menu shows agents alphabetically with (ready)/(not built) status
- Empty input selects first agent (alphabetically)
- Invalid input shows hint and re-prompts
- Single agent auto-selects without menu
- Unbuilt agent triggers "Build now?" prompt
- --agent flag bypasses menu entirely
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-agent-support/03-02-SUMMARY.md`
</output>

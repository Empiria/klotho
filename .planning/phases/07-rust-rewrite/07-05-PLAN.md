---
phase: 07-rust-rewrite
plan: 05
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - src/commands/stop.rs
  - src/commands/restart.rs
  - src/commands/ls.rs
  - src/commands/rm.rs
  - src/commands/mod.rs
  - src/main.rs
autonomous: true

must_haves:
  truths:
    - "klotho stop stops running container"
    - "klotho restart starts stopped container and attaches"
    - "klotho ls lists all sessions with status"
    - "klotho rm removes stopped container with confirmation"
  artifacts:
    - path: "src/commands/stop.rs"
      provides: "Stop command implementation"
      contains: "pub fn run"
    - path: "src/commands/restart.rs"
      provides: "Restart command implementation"
      contains: "pub fn run"
    - path: "src/commands/ls.rs"
      provides: "List command implementation"
      contains: "pub fn run"
    - path: "src/commands/rm.rs"
      provides: "Remove command implementation"
      contains: "pub fn run"
  key_links:
    - from: "src/commands/*.rs"
      to: "src/container.rs"
      via: "container operations"
      pattern: "container::"
---

<objective>
Implement stop, restart, ls, and rm commands for session lifecycle management.

Purpose: Complete the session management commands from the bash version.
Output: All session lifecycle commands working (stop, restart, ls, rm).
</objective>

<execution_context>
@/home/owen/.claude/get-shit-done/workflows/execute-plan.md
@/home/owen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-rust-rewrite/07-02-SUMMARY.md
@.planning/phases/07-rust-rewrite/07-04-SUMMARY.md

# Reference implementation
@klotho
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement stop and restart commands</name>
  <files>src/commands/stop.rs, src/commands/restart.rs, src/commands/mod.rs</files>
  <action>
Implement stop and restart commands:

src/commands/stop.rs:
```rust
use anyhow::{bail, Result};
use crate::container::{detect_runtime, find_container, stop_container};

pub fn run(name: String) -> Result<()> {
    let runtime = detect_runtime()?;

    // Find container by session name
    let container = find_container(runtime, &name)?;

    match container {
        Some(info) => {
            // Stop is idempotent
            stop_container(runtime, &info.full_name)?;
            println!("Stopped: {}", name);
            Ok(())
        }
        None => {
            bail!("Session '{}' not found.\nUse 'klotho ls' to see available sessions.", name);
        }
    }
}
```

src/commands/restart.rs:
```rust
use anyhow::{bail, Result};
use std::process::{Command, Stdio};

use crate::config::load_agent_config;
use crate::container::{detect_runtime, find_container, start_container, ContainerStatus, container_status};

pub fn run(name: String) -> Result<()> {
    let runtime = detect_runtime()?;

    // Find container by session name
    let container = find_container(runtime, &name)?;

    let info = match container {
        Some(info) => info,
        None => {
            bail!("Session '{}' not found.\nUse 'klotho ls' to see available sessions.", name);
        }
    };

    // Load agent config
    let config = load_agent_config(&info.agent)?;

    // Start if stopped
    if !info.is_running {
        println!("Starting '{}'...", name);
        start_container(runtime, &info.full_name)?;
        std::thread::sleep(std::time::Duration::from_secs(1));
    } else {
        println!("Session '{}' is already running. Attaching...", name);
    }

    // Attach to zellij
    attach_zellij(runtime, &info.full_name, &name, &config)
}

fn attach_zellij(
    runtime: crate::container::Runtime,
    container_name: &str,
    session_name: &str,
    config: &crate::agent::AgentConfig,
) -> Result<()> {
    // Check if zellij session exists
    let check = Command::new(runtime.as_str())
        .args(["exec", container_name, "zellij", "list-sessions"])
        .output()?;

    let stdout = String::from_utf8_lossy(&check.stdout);
    let clean_output: String = stdout
        .chars()
        .filter(|c| !c.is_control() || *c == '\n')
        .collect();
    let session_exists = clean_output
        .lines()
        .any(|line| line.trim().starts_with(session_name));

    let zellij_cmd = if session_exists {
        format!(
            "zellij attach '{}'; zellij list-sessions 2>/dev/null | sed 's/\\x1b\\[[0-9;]*m//g' | grep -q '^{} ' || exec {}",
            session_name, session_name, config.shell
        )
    } else {
        format!(
            "zellij -s '{}'; zellij list-sessions 2>/dev/null | sed 's/\\x1b\\[[0-9;]*m//g' | grep -q '^{} ' || exec {}",
            session_name, session_name, config.shell
        )
    };

    let shell_env = format!("/home/agent/.local/bin/{}-session", config.name);
    let mut cmd = Command::new(runtime.as_str());
    cmd.args(["exec", "-it"]);
    cmd.args(["-e", &format!("SHELL={}", shell_env)]);
    cmd.args(["-e", &format!("AGENT_LAUNCH_CMD={}", config.launch_cmd)]);
    cmd.args([container_name, "bash", "-c", &zellij_cmd]);

    cmd.stdin(Stdio::inherit());
    cmd.stdout(Stdio::inherit());
    cmd.stderr(Stdio::inherit());

    let status = cmd.status()?;

    if !status.success() {
        anyhow::bail!("Container exec exited with error");
    }

    Ok(())
}
```

Update src/commands/mod.rs:
```rust
pub mod start;
pub mod build;
pub mod stop;
pub mod restart;
```
  </action>
  <verify>
```bash
cargo build
cargo run -- stop --help
cargo run -- restart --help
```
  </verify>
  <done>Stop and restart commands implemented</done>
</task>

<task type="auto">
  <name>Task 2: Implement ls and rm commands</name>
  <files>src/commands/ls.rs, src/commands/rm.rs, src/commands/mod.rs, src/main.rs</files>
  <action>
Implement ls and rm commands:

src/commands/ls.rs:
```rust
use anyhow::Result;
use owo_colors::OwoColorize;

use crate::container::{detect_runtime, list_containers};

pub fn run() -> Result<()> {
    let runtime = detect_runtime()?;
    let containers = list_containers(runtime)?;

    if containers.is_empty() {
        println!("No sessions found.");
        return Ok(());
    }

    // Print header
    println!(
        "{:<20} {:<12} {}",
        "NAME".bold(),
        "AGENT".bold(),
        "STATUS".bold()
    );

    for container in containers {
        let status = if container.is_running {
            "running".green().to_string()
        } else {
            "stopped".red().to_string()
        };

        println!(
            "{:<20} {:<12} {}",
            container.session_name,
            container.agent,
            status
        );
    }

    Ok(())
}
```

src/commands/rm.rs:
```rust
use anyhow::{bail, Result};
use std::io::{self, Write};

use crate::container::{detect_runtime, find_container, remove_container};

pub fn run(name: String, force: bool) -> Result<()> {
    let runtime = detect_runtime()?;

    // Find container by session name
    let container = find_container(runtime, &name)?;

    let info = match container {
        Some(info) => info,
        None => {
            bail!("Session '{}' not found.\nUse 'klotho ls' to see available sessions.", name);
        }
    };

    // Cannot remove running container
    if info.is_running {
        bail!(
            "Cannot remove running session '{}'.\nStop it first with: klotho stop {}",
            name,
            name
        );
    }

    // Confirm unless --force
    if !force {
        print!("Remove session '{}'? [y/N] ", name);
        io::stdout().flush()?;

        let mut input = String::new();
        io::stdin().read_line(&mut input)?;
        let answer = input.trim().to_lowercase();

        if answer != "y" && answer != "yes" {
            println!("Cancelled.");
            return Ok(());
        }
    }

    remove_container(runtime, &info.full_name)?;
    println!("Removed: {}", name);

    Ok(())
}
```

Update src/commands/mod.rs:
```rust
pub mod start;
pub mod build;
pub mod stop;
pub mod restart;
pub mod ls;
pub mod rm;
```

Update src/main.rs to wire up all commands:
```rust
use anyhow::Result;
use clap::Parser;
use klotho::cli::{Cli, Commands};

fn main() -> Result<()> {
    let cli = Cli::parse();

    match cli.command {
        Commands::Start { agent, name, paths } => {
            // Convert default agent to None for interactive selection
            // Only if -a/--agent wasn't explicitly provided
            let agent = if agent == "claude" {
                // Check if -a or --agent was in args
                let args: Vec<String> = std::env::args().collect();
                let explicit_agent = args.iter().any(|a| a == "-a" || a == "--agent");
                if explicit_agent {
                    Some(agent)
                } else {
                    None
                }
            } else {
                Some(agent)
            };
            klotho::commands::start::run(agent, name, paths)
        }
        Commands::Stop { name } => {
            klotho::commands::stop::run(name)
        }
        Commands::Restart { name } => {
            klotho::commands::restart::run(name)
        }
        Commands::Ls => {
            klotho::commands::ls::run()
        }
        Commands::Rm { force, name } => {
            klotho::commands::rm::run(name, force)
        }
        Commands::Build { all, agents } => {
            todo!("Implement build command")
        }
        Commands::Rebuild { all, agents } => {
            todo!("Implement rebuild command")
        }
    }
}
```
  </action>
  <verify>
```bash
cargo build
cargo run -- ls
cargo run -- rm --help
```

Test with actual containers:
```bash
# List sessions (should show any existing)
cargo run -- ls

# Stop a session
cargo run -- stop default

# Restart and attach
cargo run -- restart default

# Remove (with confirmation)
cargo run -- rm default

# Remove (skip confirmation)
cargo run -- rm -f test
```
  </verify>
  <done>
All session commands work: ls shows sessions with colored status, rm confirms before removal, stop/restart handle edge cases
  </done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
cargo build

# Help text
cargo run -- stop --help
cargo run -- restart --help
cargo run -- ls --help
cargo run -- rm --help

# Functional tests
cargo run -- ls                    # List sessions
cargo run -- stop default          # Stop session
cargo run -- restart default       # Restart and attach
cargo run -- rm default            # Remove with confirmation
cargo run -- rm -f test            # Force remove
```
</verification>

<success_criteria>
- stop command stops container (idempotent)
- restart command starts stopped container and attaches to Zellij
- ls command lists sessions with colored status (green=running, red=stopped)
- rm command confirms before removal (unless --force)
- All commands handle "not found" errors gracefully
- Legacy container naming supported in all commands
</success_criteria>

<output>
After completion, create `.planning/phases/07-rust-rewrite/07-05-SUMMARY.md`
</output>

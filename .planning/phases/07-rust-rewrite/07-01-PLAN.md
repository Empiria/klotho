---
phase: 07-rust-rewrite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/main.rs
  - src/cli.rs
  - src/lib.rs
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "cargo build compiles without errors"
    - "klotho --help shows all subcommands"
    - "klotho <cmd> --help shows command-specific help"
  artifacts:
    - path: "Cargo.toml"
      provides: "Project manifest with all dependencies"
      contains: "clap"
    - path: "src/main.rs"
      provides: "Entry point dispatching to commands"
      contains: "fn main"
    - path: "src/cli.rs"
      provides: "Clap derive structs for CLI"
      contains: "#[derive(Parser)]"
  key_links:
    - from: "src/main.rs"
      to: "src/cli.rs"
      via: "use klotho::cli"
      pattern: "use klotho::cli"
---

<objective>
Initialize Rust project with clap-based CLI structure matching the bash version's command interface.

Purpose: Foundation for all Rust CLI work - establishes project structure, dependencies, and command routing.
Output: Compilable Rust project with help text for all commands (implementations are stubs).
</objective>

<execution_context>
@/home/owen/.claude/get-shit-done/workflows/execute-plan.md
@/home/owen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-rust-rewrite/07-CONTEXT.md
@.planning/phases/07-rust-rewrite/07-RESEARCH.md

# Reference for command structure and help text
@klotho
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Cargo project with dependencies</name>
  <files>Cargo.toml, .gitignore</files>
  <action>
Create new Rust project in the repository root:
1. Create Cargo.toml with:
   - name = "klotho"
   - version = "0.1.0"
   - edition = "2021"
   - Dependencies as specified in RESEARCH.md:
     - clap = { version = "4.5", features = ["derive"] }
     - anyhow = "1.0"
     - indicatif = "0.17"
     - owo-colors = "4.0"
     - rust-embed = "8"
     - serde = { version = "1.0", features = ["derive"] }
     - toml = "0.8"
     - dialoguer = "0.11"

2. Update .gitignore to add Rust artifacts:
   - /target/
   - Cargo.lock (or keep it, either is fine for binaries)

Note: Keep existing bash script files - they remain the working implementation until Rust version is complete.
  </action>
  <verify>cargo check runs without errors (downloads deps, validates Cargo.toml)</verify>
  <done>Cargo.toml exists with all dependencies, cargo check succeeds</done>
</task>

<task type="auto">
  <name>Task 2: Create CLI structure with clap derive</name>
  <files>src/main.rs, src/cli.rs, src/lib.rs</files>
  <action>
Create CLI structure matching bash version's interface:

src/cli.rs - Define clap structs:
```rust
use clap::{Parser, Subcommand};

#[derive(Parser)]
#[command(name = "klotho")]
#[command(about = "Run AI agents in isolated containers with persistent Zellij sessions")]
#[command(version)]
pub struct Cli {
    #[command(subcommand)]
    pub command: Commands,
}

#[derive(Subcommand)]
pub enum Commands {
    /// Create a new session or attach to existing one
    Start {
        /// Agent to use (default: "claude")
        #[arg(short, long, default_value = "claude")]
        agent: String,

        /// Session name (default: "default")
        #[arg(short, long, default_value = "default")]
        name: String,

        /// Project paths to mount
        paths: Vec<String>,
    },

    /// Stop a running session
    Stop {
        /// Session name (default: "default")
        #[arg(default_value = "default")]
        name: String,
    },

    /// Start a stopped session and reattach
    Restart {
        /// Session name (default: "default")
        #[arg(default_value = "default")]
        name: String,
    },

    /// List all sessions with status
    Ls,

    /// Remove a stopped session
    Rm {
        /// Skip confirmation prompt
        #[arg(short, long)]
        force: bool,

        /// Session name (default: "default")
        #[arg(default_value = "default")]
        name: String,
    },

    /// Build agent container image
    Build {
        /// Build all agents
        #[arg(long)]
        all: bool,

        /// Agent name(s) to build
        agents: Vec<String>,
    },

    /// Rebuild agent container image (no cache)
    Rebuild {
        /// Rebuild all agents
        #[arg(long)]
        all: bool,

        /// Agent name(s) to rebuild
        agents: Vec<String>,
    },
}
```

src/lib.rs - Re-export modules:
```rust
pub mod cli;
```

src/main.rs - Entry point with stub dispatch:
```rust
use anyhow::Result;
use clap::Parser;
use klotho::cli::{Cli, Commands};

fn main() -> Result<()> {
    let cli = Cli::parse();

    match cli.command {
        Commands::Start { agent, name, paths } => {
            println!("start: agent={}, name={}, paths={:?}", agent, name, paths);
            todo!("Implement start command")
        }
        Commands::Stop { name } => {
            println!("stop: name={}", name);
            todo!("Implement stop command")
        }
        Commands::Restart { name } => {
            println!("restart: name={}", name);
            todo!("Implement restart command")
        }
        Commands::Ls => {
            println!("ls");
            todo!("Implement ls command")
        }
        Commands::Rm { force, name } => {
            println!("rm: force={}, name={}", force, name);
            todo!("Implement rm command")
        }
        Commands::Build { all, agents } => {
            println!("build: all={}, agents={:?}", all, agents);
            todo!("Implement build command")
        }
        Commands::Rebuild { all, agents } => {
            println!("rebuild: all={}, agents={:?}", all, agents);
            todo!("Implement rebuild command")
        }
    }
}
```

Key decisions:
- Use derive API for ergonomic argument parsing
- Match bash version's flag names exactly (-a/--agent, -n/--name, -f/--force)
- Add new build/rebuild commands not in bash version
- Stub implementations print args and todo!() - will be implemented in later plans
  </action>
  <verify>
1. cargo build compiles without errors
2. cargo run -- --help shows main help with all commands
3. cargo run -- start --help shows start-specific help
4. cargo run -- build --help shows build-specific help
  </verify>
  <done>
CLI structure complete: all 7 commands defined with proper arguments, help text matches or improves bash version
  </done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
cargo build

# Help text works
cargo run -- --help
cargo run -- start --help
cargo run -- stop --help
cargo run -- restart --help
cargo run -- ls --help
cargo run -- rm --help
cargo run -- build --help
cargo run -- rebuild --help

# Version flag works
cargo run -- --version
```
</verification>

<success_criteria>
- Cargo project compiles without warnings
- All 7 subcommands visible in --help
- Each command has proper --help with argument descriptions
- Flag names match bash version (-a, -n, -f)
- New build/rebuild commands have --all flag
</success_criteria>

<output>
After completion, create `.planning/phases/07-rust-rewrite/07-01-SUMMARY.md`
</output>

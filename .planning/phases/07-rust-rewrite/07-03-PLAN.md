---
phase: 07-rust-rewrite
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/resources.rs
  - src/resources/Containerfile
  - src/resources/entrypoint.sh
  - src/resources/agents/claude/config.conf
  - src/resources/agents/opencode/config.conf
  - src/lib.rs
autonomous: true

must_haves:
  truths:
    - "Binary embeds Containerfile and entrypoint.sh"
    - "Binary embeds agent config files"
    - "Embedded resources can be extracted to temp directory"
  artifacts:
    - path: "src/resources.rs"
      provides: "rust-embed resource access"
      contains: "#[derive(RustEmbed)]"
    - path: "src/resources/Containerfile"
      provides: "Embedded container definition"
      contains: "FROM"
  key_links:
    - from: "src/resources.rs"
      to: "rust_embed::RustEmbed"
      via: "derive macro"
      pattern: "RustEmbed"
---

<objective>
Embed Containerfile, entrypoint.sh, and agent configs into the binary for single-binary distribution.

Purpose: Enable the Rust binary to work standalone without needing the repo's config/ directory.
Output: Resources module that provides access to embedded files, extractable to temp directory for builds.
</objective>

<execution_context>
@/home/owen/.claude/get-shit-done/workflows/execute-plan.md
@/home/owen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-rust-rewrite/07-CONTEXT.md
@.planning/phases/07-rust-rewrite/07-RESEARCH.md
@.planning/phases/07-rust-rewrite/07-01-SUMMARY.md

# Files to embed
@Containerfile
@entrypoint.sh
@config/agents/claude/config.conf
@config/agents/opencode/config.conf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create resources directory with files to embed</name>
  <files>src/resources/Containerfile, src/resources/entrypoint.sh, src/resources/agents/claude/config.conf, src/resources/agents/opencode/config.conf</files>
  <action>
Create src/resources/ directory and copy files to embed:

1. Create directory structure:
```
src/resources/
├── Containerfile
├── entrypoint.sh
└── agents/
    ├── claude/
    │   └── config.conf
    └── opencode/
        └── config.conf
```

2. Copy files:
- Copy Containerfile to src/resources/Containerfile
- Copy entrypoint.sh to src/resources/entrypoint.sh
- Copy config/agents/claude/config.conf to src/resources/agents/claude/config.conf
- Copy config/agents/opencode/config.conf to src/resources/agents/opencode/config.conf

Note: Also copy config/agents/opencode/opencode.json if it exists (MCP config).

These are the files that will be compiled into the binary. The originals in the repo root remain for the bash version and development.
  </action>
  <verify>
```bash
ls -la src/resources/
ls -la src/resources/agents/claude/
ls -la src/resources/agents/opencode/
```
  </verify>
  <done>Resource files exist in src/resources/ ready for embedding</done>
</task>

<task type="auto">
  <name>Task 2: Implement rust-embed resources module</name>
  <files>src/resources.rs, src/lib.rs, src/config.rs</files>
  <action>
Create resources module using rust-embed:

src/resources.rs:
```rust
use anyhow::{Context, Result};
use rust_embed::RustEmbed;
use std::path::{Path, PathBuf};

#[derive(RustEmbed)]
#[folder = "src/resources/"]
pub struct Resources;

/// Get embedded Containerfile content
pub fn get_containerfile() -> Result<String> {
    let file = Resources::get("Containerfile")
        .context("Containerfile not found in embedded resources")?;
    Ok(String::from_utf8_lossy(&file.data).into_owned())
}

/// Get embedded entrypoint.sh content
pub fn get_entrypoint() -> Result<String> {
    let file = Resources::get("entrypoint.sh")
        .context("entrypoint.sh not found in embedded resources")?;
    Ok(String::from_utf8_lossy(&file.data).into_owned())
}

/// Get embedded agent config content
pub fn get_agent_config(agent: &str) -> Result<String> {
    let path = format!("agents/{}/config.conf", agent);
    let file = Resources::get(&path)
        .context(format!("Agent config not found: {}", path))?;
    Ok(String::from_utf8_lossy(&file.data).into_owned())
}

/// List available embedded agents
pub fn list_embedded_agents() -> Vec<String> {
    let mut agents = Vec::new();

    for path in Resources::iter() {
        // Look for agents/*/config.conf patterns
        if let Some(rest) = path.strip_prefix("agents/") {
            if let Some(agent) = rest.split('/').next() {
                if !agents.contains(&agent.to_string()) {
                    agents.push(agent.to_string());
                }
            }
        }
    }

    agents.sort();
    agents
}

/// Extract embedded resources to a temporary directory for building
/// Returns the path to the temp directory
pub fn extract_build_context() -> Result<PathBuf> {
    let temp_dir = std::env::temp_dir().join("klotho-build");

    // Clean and recreate
    if temp_dir.exists() {
        std::fs::remove_dir_all(&temp_dir)
            .context("Failed to clean temp directory")?;
    }
    std::fs::create_dir_all(&temp_dir)
        .context("Failed to create temp directory")?;

    // Write Containerfile
    let containerfile = get_containerfile()?;
    std::fs::write(temp_dir.join("Containerfile"), containerfile)
        .context("Failed to write Containerfile")?;

    // Write entrypoint.sh
    let entrypoint = get_entrypoint()?;
    std::fs::write(temp_dir.join("entrypoint.sh"), entrypoint)
        .context("Failed to write entrypoint.sh")?;

    // Make entrypoint executable (Unix only)
    #[cfg(unix)]
    {
        use std::os::unix::fs::PermissionsExt;
        let mut perms = std::fs::metadata(temp_dir.join("entrypoint.sh"))?.permissions();
        perms.set_mode(0o755);
        std::fs::set_permissions(temp_dir.join("entrypoint.sh"), perms)?;
    }

    // Write agent configs
    let config_dir = temp_dir.join("config").join("agents");
    for agent in list_embedded_agents() {
        let agent_dir = config_dir.join(&agent);
        std::fs::create_dir_all(&agent_dir)
            .context(format!("Failed to create agent dir: {}", agent))?;

        let config = get_agent_config(&agent)?;
        std::fs::write(agent_dir.join("config.conf"), config)
            .context(format!("Failed to write config for: {}", agent))?;

        // Also extract opencode.json if it exists
        if let Some(file) = Resources::get(&format!("agents/{}/opencode.json", agent)) {
            std::fs::write(agent_dir.join("opencode.json"), &file.data)
                .context("Failed to write opencode.json")?;
        }
    }

    Ok(temp_dir)
}

/// Check if running from repo (has local config/) or needs embedded resources
pub fn should_use_embedded() -> bool {
    // If local config/ exists, prefer it (development mode)
    !Path::new("config").exists()
}
```

Update src/lib.rs:
```rust
pub mod cli;
pub mod config;
pub mod agent;
pub mod container;
pub mod resources;
```

Update src/config.rs to use embedded resources when appropriate:
Add to get_repo_config_dir():
```rust
/// Get the repository config directory (embedded or local)
pub fn get_repo_config_dir() -> Result<PathBuf> {
    // Development mode: use local config/
    if Path::new("config").exists() {
        return Ok(PathBuf::from("config"));
    }

    // Production mode: extract embedded resources
    crate::resources::extract_build_context()
        .map(|p| p.join("config"))
}
```
  </action>
  <verify>
Add test to main.rs:
```rust
// Test embedded resources
println!("Embedded agents: {:?}", klotho::resources::list_embedded_agents());
println!("Containerfile length: {} bytes", klotho::resources::get_containerfile()?.len());
```
Run: cargo run -- start (tests resource loading)

Also verify:
```bash
# Build release to ensure resources are embedded
cargo build --release
# Check binary size increased (resources embedded)
ls -la target/release/klotho
```
  </verify>
  <done>
Resources embedded: Containerfile, entrypoint.sh, and agent configs compiled into binary, extractable for builds
  </done>
</task>

</tasks>

<verification>
```bash
# Build succeeds with embedded resources
cargo build

# Test resource access
cargo run -- start  # Should print embedded agent count before todo!()

# Verify resources are in binary (build release)
cargo build --release
ls -la target/release/klotho  # Should be larger than minimal binary
```
</verification>

<success_criteria>
- src/resources/ directory contains all files to embed
- rust-embed compiles resources into binary
- list_embedded_agents() returns ["claude", "opencode"]
- extract_build_context() creates temp directory with correct structure
- Binary works without local config/ directory
</success_criteria>

<output>
After completion, create `.planning/phases/07-rust-rewrite/07-03-SUMMARY.md`
</output>

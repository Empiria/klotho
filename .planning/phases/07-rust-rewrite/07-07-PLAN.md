---
phase: 07-rust-rewrite
plan: 07
type: execute
wave: 4
depends_on: ["07-04", "07-05", "07-06"]
files_modified:
  - .github/workflows/release.yml
  - install.sh
autonomous: true

must_haves:
  truths:
    - "GitHub Actions builds binaries for Linux, macOS, Windows"
    - "Releases include pre-built binaries for all platforms"
    - "curl | sh installer downloads correct binary for platform"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "CI/CD for releases"
      contains: "cross"
    - path: "install.sh"
      provides: "curl | sh installer"
      contains: "main()"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "GitHub Releases"
      via: "upload-artifact"
      pattern: "actions/upload-artifact"
---

<objective>
Set up GitHub Actions for multi-platform builds and create installer script.

Purpose: Enable single-binary distribution via GitHub releases and easy installation.
Output: CI/CD pipeline that builds releases + curl | sh installer script.
</objective>

<execution_context>
@/home/owen/.claude/get-shit-done/workflows/execute-plan.md
@/home/owen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-rust-rewrite/07-CONTEXT.md
@.planning/phases/07-rust-rewrite/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions release workflow</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create GitHub Actions workflow for multi-platform releases:

.github/workflows/release.yml:
```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (musl for static binary)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact: klotho-linux-x86_64
            cross: true

          # Linux aarch64 (musl for static binary)
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            artifact: klotho-linux-aarch64
            cross: true

          # macOS x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: klotho-darwin-x86_64
            cross: false

          # macOS aarch64 (Apple Silicon)
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: klotho-darwin-aarch64
            cross: false

          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: klotho-windows-x86_64.exe
            cross: false

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }}

      - name: Build (native)
        if: "!matrix.cross"
        run: cargo build --release --target ${{ matrix.target }}

      - name: Rename binary (Unix)
        if: runner.os != 'Windows'
        run: mv target/${{ matrix.target }}/release/klotho ${{ matrix.artifact }}

      - name: Rename binary (Windows)
        if: runner.os == 'Windows'
        run: mv target/${{ matrix.target }}/release/klotho.exe ${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create checksums
        run: |
          cd artifacts
          for dir in */; do
            cd "$dir"
            sha256sum * > checksums.txt || true
            cd ..
          done
          # Combine all checksums
          find . -name 'checksums.txt' -exec cat {} \; > ../SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/klotho-linux-x86_64/klotho-linux-x86_64
            artifacts/klotho-linux-aarch64/klotho-linux-aarch64
            artifacts/klotho-darwin-x86_64/klotho-darwin-x86_64
            artifacts/klotho-darwin-aarch64/klotho-darwin-aarch64
            artifacts/klotho-windows-x86_64.exe/klotho-windows-x86_64.exe
            SHA256SUMS.txt
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

Create the .github/workflows directory if it doesn't exist.
  </action>
  <verify>
```bash
ls -la .github/workflows/release.yml
cat .github/workflows/release.yml | head -50
```
Verify YAML syntax is valid.
  </verify>
  <done>GitHub Actions workflow created for multi-platform builds</done>
</task>

<task type="auto">
  <name>Task 2: Create installer script</name>
  <files>install.sh</files>
  <action>
Create installer script for curl | sh installation:

install.sh:
```bash
#!/bin/bash
# Klotho installer script
# Usage: curl -fsSL https://raw.githubusercontent.com/OWNER/klotho/main/install.sh | bash
#
# This script detects your platform and downloads the appropriate binary.

set -euo pipefail

# Wrap everything in main() to prevent partial execution if download is interrupted
main() {
    # Configuration
    REPO="OWNER/klotho"  # TODO: Update with actual repo owner
    INSTALL_DIR="${KLOTHO_INSTALL_DIR:-$HOME/.local/bin}"
    BINARY_NAME="klotho"

    # Colors (disabled if not a terminal)
    if [[ -t 1 ]]; then
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[0;33m'
        RESET='\033[0m'
    else
        RED=''
        GREEN=''
        YELLOW=''
        RESET=''
    fi

    info() { echo -e "${GREEN}[info]${RESET} $*"; }
    warn() { echo -e "${YELLOW}[warn]${RESET} $*" >&2; }
    error() { echo -e "${RED}[error]${RESET} $*" >&2; exit 1; }

    # Detect platform
    detect_platform() {
        local os arch

        case "$(uname -s)" in
            Linux*)  os="linux" ;;
            Darwin*) os="darwin" ;;
            MINGW*|MSYS*|CYGWIN*) os="windows" ;;
            *) error "Unsupported OS: $(uname -s)" ;;
        esac

        case "$(uname -m)" in
            x86_64|amd64) arch="x86_64" ;;
            aarch64|arm64) arch="aarch64" ;;
            *) error "Unsupported architecture: $(uname -m)" ;;
        esac

        echo "${os}-${arch}"
    }

    # Get latest release version
    get_latest_version() {
        curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" \
            | grep '"tag_name"' \
            | sed -E 's/.*"([^"]+)".*/\1/'
    }

    # Download and install
    install() {
        local platform version url binary_suffix

        platform=$(detect_platform)
        info "Detected platform: $platform"

        version=$(get_latest_version)
        if [[ -z "$version" ]]; then
            error "Failed to get latest version"
        fi
        info "Latest version: $version"

        # Construct download URL
        case "$platform" in
            windows-*) binary_suffix=".exe" ;;
            *) binary_suffix="" ;;
        esac

        url="https://github.com/${REPO}/releases/download/${version}/klotho-${platform}${binary_suffix}"
        info "Downloading from: $url"

        # Create install directory
        mkdir -p "$INSTALL_DIR"

        # Download binary
        local tmp_file
        tmp_file=$(mktemp)
        trap "rm -f $tmp_file" EXIT

        if ! curl -fsSL "$url" -o "$tmp_file"; then
            error "Failed to download binary"
        fi

        # Make executable and move to install dir
        chmod +x "$tmp_file"
        mv "$tmp_file" "${INSTALL_DIR}/${BINARY_NAME}"

        info "Installed to: ${INSTALL_DIR}/${BINARY_NAME}"

        # Check if install dir is in PATH
        if ! echo "$PATH" | tr ':' '\n' | grep -q "^${INSTALL_DIR}$"; then
            warn "Note: ${INSTALL_DIR} is not in your PATH"
            warn "Add this to your shell profile:"
            warn "  export PATH=\"\$PATH:${INSTALL_DIR}\""
        fi

        info "Installation complete!"
        info "Run 'klotho --help' to get started"
    }

    # Run installation
    install
}

# Only run main if script was not sourced
main "$@"
```

Note: The REPO variable needs to be updated with the actual GitHub owner/repo when known.
  </action>
  <verify>
```bash
# Check script syntax
bash -n install.sh

# Check script is executable concepts are present
grep -q "main()" install.sh
grep -q "detect_platform" install.sh
grep -q "curl" install.sh
```
  </verify>
  <done>
Installer script created: detects platform, downloads correct binary, handles PATH warning
  </done>
</task>

</tasks>

<verification>
```bash
# Verify workflow file
cat .github/workflows/release.yml

# Verify installer script syntax
bash -n install.sh

# Check installer contains main() wrapper (prevents partial execution)
grep -A2 "^main()" install.sh
```
</verification>

<success_criteria>
- GitHub Actions workflow builds for all 5 targets (Linux x64/arm64, macOS x64/arm64, Windows)
- Workflow triggers on version tags (v*)
- Release includes SHA256 checksums
- Installer script wrapped in main() for safety
- Installer detects platform and downloads correct binary
- Installer warns if install dir not in PATH
</success_criteria>

<output>
After completion, create `.planning/phases/07-rust-rewrite/07-07-SUMMARY.md`
</output>

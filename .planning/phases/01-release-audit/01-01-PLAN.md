---
phase: 01-release-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agent-session
  - entrypoint.sh
autonomous: true

must_haves:
  truths:
    - "Secret scanner reports zero secrets in repository history"
    - "grep for personal usernames returns zero matches in source files"
    - "ShellCheck passes on all shell scripts with no errors"
  artifacts:
    - path: "agent-session"
      provides: "Main orchestration script"
      clean_of: "hardcoded usernames, personal paths"
    - path: "entrypoint.sh"
      provides: "Container entrypoint script"
      clean_of: "hardcoded usernames, personal paths"
  key_links:
    - from: "gitleaks"
      to: "entire git history"
      via: "gitleaks detect --source=."
      critical: "Secrets in history remain even if removed from HEAD"
    - from: "shellcheck"
      to: "all shell scripts"
      via: "shellcheck agent-session entrypoint.sh"
      critical: "Portability issues cause failures on other machines"
---

<objective>
Run security and portability audits on the codebase to ensure it contains no secrets, hardcoded personal paths, or shell script portability issues.

Purpose: Verify the codebase is safe and portable for team distribution before any other release work
Output: Clean audit results confirming no secrets, no hardcoded paths, and portable shell scripts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-release-audit/01-RESEARCH.md
@agent-session
@entrypoint.sh
@Containerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Secret scanning with Gitleaks</name>
  <files>No files modified - audit only</files>
  <action>
Run Gitleaks to scan the entire git repository history for secrets, API keys, and credentials.

Steps:
1. Check if gitleaks is installed: `command -v gitleaks || echo "Install: https://github.com/gitleaks/gitleaks#installing"`
2. If not installed, use Docker: `docker run -v $(pwd):/repo zricethezav/gitleaks:latest detect --source=/repo --verbose`
3. If installed: `gitleaks detect --source=. --verbose`

Expected: Exit code 0 (no leaks detected)

If secrets are found:
- Document each finding with file path and line number
- Determine if secret is active (API key) or example/documentation
- For active secrets: They must be rotated even if removed from code (history persists)
- For example/documentation: Consider using placeholder patterns like `sk-xxxx...xxxx`

Do NOT commit any changes in this task - this is an audit only.
  </action>
  <verify>
`gitleaks detect --source=. --exit-code 1` exits with code 0 (no leaks)
OR
If using Docker: `docker run -v $(pwd):/repo zricethezav/gitleaks:latest detect --source=/repo --exit-code 1` exits with code 0
  </verify>
  <done>Gitleaks reports zero secrets in repository history, or all findings documented as false positives with justification</done>
</task>

<task type="auto">
  <name>Task 2: Hardcoded path and ShellCheck audit</name>
  <files>agent-session, entrypoint.sh</files>
  <action>
Run portability audits to ensure no hardcoded personal paths and shell scripts are portable.

Part A - Hardcoded path/username detection:
1. Search for potential hardcoded usernames in source files (not planning docs):
   ```bash
   rg -i "owen|/home/[a-zA-Z0-9_-]+/" agent-session entrypoint.sh Containerfile 2>/dev/null | grep -v '/home/agent'
   ```
   Expected: No matches (except /home/agent which is the container user)

2. Search for machine-specific absolute paths:
   ```bash
   rg "(^|[\"' =])/Users/|C:\\\\Users\\\\" agent-session entrypoint.sh Containerfile
   ```
   Expected: No matches

3. Check for $HOME used correctly (should expand at runtime, not be hardcoded):
   ```bash
   rg '\$HOME' agent-session entrypoint.sh
   ```
   Expected: All $HOME references should be in mount commands where they expand to user's actual home

Part B - ShellCheck analysis:
1. Run ShellCheck on both scripts:
   ```bash
   shellcheck --severity=warning agent-session entrypoint.sh
   ```

2. If issues found, fix them following ShellCheck recommendations:
   - SC2086: Quote variable expansions
   - SC2046: Quote command substitutions
   - SC2039: Replace bashisms for POSIX compliance (only if shebang is /bin/sh)

For this codebase, scripts use `#!/bin/bash` so bash-specific features are acceptable, but quoting issues should still be fixed.

Common fixes needed (from CONCERNS.md):
- Line 147-148 in agent-session: Quote `$EXTRA_MOUNTS` and `$MOUNTS`
- These need careful handling because they contain multiple -v flags that must word-split

Strategy for MOUNTS variable:
- Convert from string to array: `MOUNTS=()` then `MOUNTS+=("-v" "$abs_path:/workspace/$dir_name:Z")`
- Use `"${MOUNTS[@]}"` expansion in podman run command

Apply fixes if ShellCheck finds issues.
  </action>
  <verify>
1. `rg -i "owen" agent-session entrypoint.sh Containerfile` returns no matches
2. `rg "/home/[a-zA-Z0-9_-]+/" agent-session entrypoint.sh Containerfile | grep -v '/home/agent'` returns no matches
3. `shellcheck --severity=warning agent-session entrypoint.sh` exits with code 0
  </verify>
  <done>
- Zero hardcoded usernames in source files
- Zero machine-specific absolute paths in source files
- ShellCheck passes with no warnings on all shell scripts
  </done>
</task>

</tasks>

<verification>
All checks pass:
1. `gitleaks detect --source=. --exit-code 1` returns 0
2. `rg -i "owen" agent-session entrypoint.sh Containerfile` returns empty
3. `shellcheck --severity=warning agent-session entrypoint.sh` returns 0
</verification>

<success_criteria>
- Secret scanning complete with zero findings (or all findings documented as false positives)
- No hardcoded usernames or personal paths in source files
- ShellCheck passes on all shell scripts
- Any fixes applied are minimal and targeted (not refactoring)
</success_criteria>

<output>
After completion, create `.planning/phases/01-release-audit/01-01-SUMMARY.md`
</output>

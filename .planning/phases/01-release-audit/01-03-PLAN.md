---
phase: 01-release-audit
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [agent-session]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Tool runs successfully when ~/.claude directory does not exist"
    - "Tool runs successfully when ~/.local/share/claude directory does not exist"
    - "Tool runs successfully when ~/.config/zellij directory does not exist"
    - "Optional directories are mounted when they do exist"
  artifacts:
    - path: "agent-session"
      provides: "Conditional mount logic for optional directories"
      contains: "[[ -d"
  key_links:
    - from: "agent-session"
      to: "podman run"
      via: "OPTIONAL_MOUNTS variable expansion"
      pattern: "OPTIONAL_MOUNTS.*-v.*\\.claude"
---

<objective>
Fix unconditional mounting of optional directories in agent-session script.

Purpose: The script currently fails on fresh systems where ~/.claude, ~/.local/share/claude, or ~/.config/zellij do not exist. Podman requires mount source paths to exist, causing "statfs: no such file or directory" errors.

Output: Modified agent-session script that conditionally mounts optional directories only when they exist on the host.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-release-audit/01-VERIFICATION.md
@agent-session
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conditional mount logic for optional directories</name>
  <files>agent-session</files>
  <action>
Modify agent-session to conditionally mount optional directories. Replace lines 143-146:

Current (unconditional):
```bash
-v "$HOME/.claude:/config/.claude:Z" \
-v "$HOME/.claude.json:/home/agent/.claude.json:Z" \
-v "$HOME/.local/share/claude:/home/agent/.local/share/claude:Z" \
-v "$HOME/.config/zellij:/config/zellij:ro" \
```

New approach:
1. Before the podman run command (after EXTRA_MOUNTS block, around line 136), add an OPTIONAL_MOUNTS variable:

```bash
# Build optional mounts - only include if directory exists
OPTIONAL_MOUNTS=""
[[ -d "$HOME/.claude" ]] && OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v $HOME/.claude:/config/.claude:Z"
[[ -d "$HOME/.local/share/claude" ]] && OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v $HOME/.local/share/claude:/home/agent/.local/share/claude:Z"
[[ -d "$HOME/.config/zellij" ]] && OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v $HOME/.config/zellij:/config/zellij:ro"
```

2. In the podman run command, keep ONLY the required mount ($HOME/.claude.json) and add $OPTIONAL_MOUNTS:

```bash
podman run -d \
    --name "$CONTAINER_NAME" \
    --userns=keep-id \
    --workdir "$FIRST_DIR" \
    -v "$HOME/.claude.json:/home/agent/.claude.json:Z" \
    $OPTIONAL_MOUNTS \
    $EXTRA_MOUNTS \
    $MOUNTS \
    claude-agent \
    bash -c 'trap "exit 0" TERM; while :; do sleep 1; done'
```

Note: The order places OPTIONAL_MOUNTS after required mounts and before EXTRA_MOUNTS for logical grouping.

Why this approach:
- Uses same pattern as existing EXTRA_MOUNTS (proven pattern in codebase)
- Preserves "optional" semantics from PREREQUISITES.md (no documentation change needed)
- Simple bash conditionals - no external dependencies
- Maintains mount options (:Z, :ro) exactly as before
  </action>
  <verify>
Run shellcheck on modified script:
```bash
shellcheck agent-session
```
Should pass with no errors at warning severity.
  </verify>
  <done>
agent-session contains conditional mount logic for all three optional directories. ShellCheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify fix resolves the gap</name>
  <files>agent-session</files>
  <action>
Test that agent-session no longer fails when optional directories are missing:

1. Create a temporary test environment without the optional directories:
```bash
# Create isolated test with temporary HOME
TEST_HOME=$(mktemp -d)
mkdir -p "$TEST_HOME"
touch "$TEST_HOME/.claude.json"  # Required file only
```

2. Verify the mount logic works correctly by checking the generated podman command:
```bash
# Source the relevant portion of agent-session to check OPTIONAL_MOUNTS logic
HOME="$TEST_HOME" bash -c '
OPTIONAL_MOUNTS=""
[[ -d "$HOME/.claude" ]] && OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v $HOME/.claude:/config/.claude:Z"
[[ -d "$HOME/.local/share/claude" ]] && OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v $HOME/.local/share/claude:/home/agent/.local/share/claude:Z"
[[ -d "$HOME/.config/zellij" ]] && OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v $HOME/.config/zellij:/config/zellij:ro"
echo "OPTIONAL_MOUNTS: [$OPTIONAL_MOUNTS]"
'
# Expected output: OPTIONAL_MOUNTS: []
```

3. Test with directories present:
```bash
mkdir -p "$TEST_HOME/.claude"
HOME="$TEST_HOME" bash -c '
OPTIONAL_MOUNTS=""
[[ -d "$HOME/.claude" ]] && OPTIONAL_MOUNTS="$OPTIONAL_MOUNTS -v $HOME/.claude:/config/.claude:Z"
echo "OPTIONAL_MOUNTS: [$OPTIONAL_MOUNTS]"
'
# Expected output: OPTIONAL_MOUNTS: [ -v /tmp/.../. claude:/config/.claude:Z]
```

4. Clean up:
```bash
rm -rf "$TEST_HOME"
```

5. Grep to confirm the pattern is in place:
```bash
grep -n "\[\[ -d.*\.claude" agent-session
grep -n "\[\[ -d.*\.local/share/claude" agent-session
grep -n "\[\[ -d.*\.config/zellij" agent-session
```
All three should return matches.
  </action>
  <verify>
```bash
# Verify conditional logic exists for all three paths
grep -c "\[\[ -d.*HOME" agent-session
```
Should return 3 (one check for each optional directory).
  </verify>
  <done>
Conditional mount logic verified: OPTIONAL_MOUNTS is empty when directories don't exist, contains mounts when they do.
  </done>
</task>

</tasks>

<verification>
1. ShellCheck passes on agent-session with no errors
2. Script contains conditional checks for all three optional directories
3. OPTIONAL_MOUNTS pattern follows existing EXTRA_MOUNTS convention
4. Required mount (~/.claude.json) remains unconditional
</verification>

<success_criteria>
- agent-session no longer fails when ~/.claude, ~/.local/share/claude, or ~/.config/zellij are missing
- Optional directories are still mounted correctly when they exist
- ShellCheck validation passes
- Gap from VERIFICATION.md is closed: "Tool runs successfully on fresh Debian container with only documented prerequisites"
</success_criteria>

<output>
After completion, create `.planning/phases/01-release-audit/01-03-SUMMARY.md`
</output>
